<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ company_info.name }} POR Automator - POR Detail</title>
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='elements.css') }}">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'inter': ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'primary': {
                            50: '#eff6ff',
                            100: '#dbeafe',
                            500: '#3b82f6',
                            600: '#2563eb',
                            700: '#1d4ed8',
                            800: '#1e40af',
                            900: '#1e3a8a',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        /* Simple rounded corners for dropdown boxes */
        select {
            border-radius: 12px;
        }
        
        /* Geometric background pattern */
        /* From Uiverse.io by elijahgummer */
        .geometric-bg, .container {
            width: 100%;
            height: 100%;
            background: lightblue;
            position: relative;
            overflow: hidden;
        }

        .geometric-bg::before, .container::before {
            content: "";
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, #3498db 10%, transparent 20%),
                radial-gradient(circle, transparent 10%, #3498db 20%);
            background-size: 30px 30px;
            animation: moveBackground 8s linear infinite;
        }

        @keyframes moveBackground {
            0% {
                transform: translate(0, 0);
            }
            100% {
                transform: translate(20%, 20%);
            }
        }
        
        /* Enhanced Attach Files Button */
        .btn {
            font-size: 1.2rem;
            padding: 1rem 2.5rem;
            border: none;
            outline: none;
            border-radius: 0.4rem;
            cursor: pointer;
            text-transform: uppercase;
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
            font-weight: 700;
            transition: 0.6s;
            box-shadow: 0px 0px 60px #1f4c65;
        }
        
        .btn:active {
            scale: 0.92;
        }
        
        .btn:hover {
            background: rgb(2,29,78);
            background: linear-gradient(270deg, rgba(2, 29, 78, 0.681) 0%, rgba(31, 215, 232, 0.873) 60%);
            color: rgb(4, 4, 38);
        }
    </style>
        <style>
        /* Dark Mode Styles */
        .dark-mode {
            background: linear-gradient(135deg, #1a1a2e, #16213e, #0f3460) !important;
            color: #e2e8f0 !important;
        }
        
        .dark-mode .bg-gray-100\/80 {
            background-color: rgba(30, 41, 59, 0.8) !important;
        }
        
        .dark-mode .text-gray-900 {
            color: #f1f5f9 !important;
        }
        
        .dark-mode .text-gray-600 {
            color: #cbd5e1 !important;
        }
        
        .dark-mode .text-gray-700 {
            color: #e2e8f0 !important;
        }
        
        .dark-mode .bg-gray-100 {
            background-color: #1e293b !important;
        }
        
        .dark-mode .border-gray-200\/50 {
            border-color: rgba(51, 65, 85, 0.5) !important;
        }
        
        .dark-mode .bg-gray-100 {
            background-color: #334155 !important;
        }
        
        .dark-mode .bg-gray-50 {
            background-color: #1e293b !important; /* Darker gray for dark mode */
        }
        .dark-mode .bg-white {
            background-color: #1e293b !important; /* Darker gray for dark mode */
        }
        
                .dark-mode .hover\:bg-blue-50:hover {
            background-color: rgba(59, 130, 246, 0.2) !important; /* A darker blue for hover */
        }
        
        .dark-mode .bg-blue-100 {
            background-color: #1e3a8a !important;
        }
        
        .dark-mode .text-blue-600 {
            color: #60a5fa !important;
        }
        
        .dark-mode .bg-green-100 {
            background-color: #065f46 !important;
        }
        
        .dark-mode .text-green-600 {
            color: #34d399 !important;
        }
        
        .dark-mode .bg-yellow-100 {
            background-color: #92400e !important;
        }
        
        .dark-mode .text-yellow-600 {
            color: #fbbf24 !important;
        }
        
        .dark-mode .bg-purple-100 {
            background-color: #581c87 !important;
        }
        
        .dark-mode .text-purple-600 {
            color: #a855f7 !important;
        }
        
        .dark-mode .bg-pink-100 {
            background-color: #831843 !important;
        }
        
        .dark-mode .text-pink-600 {
            color: #ec4899 !important;
        }
        
        .dark-mode .bg-teal-100 {
            background-color: #134e4a !important;
        }
        
        .dark-mode .text-teal-600 {
            color: #0d9488 !important;
        }
        
        .dark-mode .bg-orange-100 {
            background-color: #7c2d12 !important;
        }
        
        .dark-mode .text-orange-600 {
            color: #ea580c !important;
        }
        
        .dark-mode .bg-indigo-100 {
            background-color: #312e81 !important;
        }
        
        .dark-mode .text-indigo-600 {
            color: #4f46e5 !important;
        }
        
        .dark-mode .bg-emerald-100 {
            background-color: #064e3b !important;
        }
        
        .dark-mode .text-emerald-600 {
            color: #059669 !important;
        }
    </style>
    <script>
        // Load theme preference based on database on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Check current database from backend and apply theme automatically
            const currentCompany = '{{ company }}';
            if (currentCompany === 'fdec') {
                document.body.classList.add('dark-mode');
                localStorage.setItem('darkMode', 'enabled');
                localStorage.setItem('activeDatabase', 'FDEC');
            } else {
                document.body.classList.remove('dark-mode');
                localStorage.setItem('darkMode', 'disabled');
                localStorage.setItem('activeDatabase', 'A&P');
            }
            
            // Apply the work order logic on page load
            if (document.getElementById('contentTypeSelect')) {
                applyWorkOrderLogic(document.getElementById('contentTypeSelect').value);
            }
        });
    </script>
    <style>
        .filed-stage {
            outline: 3px solid #22c55e; /* green-500 */
            outline-offset: -3px;
        }
        .filed-stage-inner {
            background-color: #f0fff4; /* A very light green */
        }
    </style>
    
    <style>
                /* From Uiverse.io by kish_3691 */
                /* More comprehensive version at shenanigans.shoghisimon.ca/collection/css-rain-bg/ */
                .a-and-p-background {
                    width: 100%;
                    height: 100%;
                    background: #cae9f1;
                    background-image: radial-gradient(4px 100px at 0px 235px, #272257, #0000),
                        radial-gradient(4px 100px at 300px 235px, #272257, #0000),
                        radial-gradient(1.5px 1.5px at 150px 117.5px, #272257 100%, #0000 150%),
                        radial-gradient(4px 100px at 0px 252px, #272257, #0000),
                        radial-gradient(4px 100px at 300px 252px, #272257, #0000),
                        radial-gradient(1.5px 1.5px at 150px 126px, #272257 100%, #0000 150%),
                        radial-gradient(4px 100px at 0px 150px, #272257, #0000),
                        radial-gradient(4px 100px at 300px 150px, #272257, #0000),
                        radial-gradient(1.5px 1.5px at 150px 75px, #272257 100%, #0000 150%),
                        radial-gradient(4px 100px at 0px 253px, #272257, #0000),
                        radial-gradient(4px 100px at 300px 253px, #272257, #0000),
                        radial-gradient(1.5px 1.5px at 150px 126.5px, #272257 100%, #0000 150%),
                        radial-gradient(4px 100px at 0px 204px, #272257, #0000),
                        radial-gradient(4px 100px at 300px 204px, #272257, #0000),
                        radial-gradient(1.5px 1.5px at 150px 102px, #272257 100%, #0000 150%),
                        radial-gradient(4px 100px at 0px 134px, #272257, #0000),
                        radial-gradient(4px 100px at 300px 134px, #272257, #0000),
                        radial-gradient(1.5px 1.5px at 150px 67px, #272257 100%, #0000 150%),
                        radial-gradient(4px 100px at 0px 179px, #272257, #0000),
                        radial-gradient(4px 100px at 300px 179px, #272257, #0000),
                        radial-gradient(1.5px 1.5px at 150px 89.5px, #272257 100%, #0000 150%),
                        radial-gradient(4px 100px at 0px 299px, #272257, #0000),
                        radial-gradient(4px 100px at 300px 299px, #272257, #0000),
                        radial-gradient(1.5px 1.5px at 150px 149.5px, #272257 100%, #0000 150%),
                        radial-gradient(4px 100px at 0px 215px, #272257, #0000),
                        radial-gradient(4px 100px at 300px 215px, #272257, #0000),
                        radial-gradient(1.5px 1.5px at 150px 107.5px, #272257 100%, #0000 150%),
                        radial-gradient(4px 100px at 0px 281px, #272257, #0000),
                        radial-gradient(4px 100px at 300px 281px, #272257, #0000),
                        radial-gradient(1.5px 1.5px at 150px 140.5px, #272257 100%, #0000 150%),
                        radial-gradient(4px 100px at 0px 158px, #272257, #0000),
                        radial-gradient(4px 100px at 300px 158px, #272257, #0000),
                        radial-gradient(1.5px 1.5px at 150px 79px, #272257 100%, #0000 150%),
                        radial-gradient(4px 100px at 0px 210px, #272257, #0000),
                        radial-gradient(4px 100px at 300px 210px, #272257, #0000),
                        radial-gradient(1.5px 1.5px at 150px 105px, #272257 100%, #0000 150%);
                    background-size:
                        300px 235px,
                        300px 235px,
                        300px 235px,
                        300px 252px,
                        300px 252px,
                        300px 252px,
                        300px 150px,
                        300px 150px,
                        300px 150px,
                        300px 253px,
                        300px 253px,
                        300px 253px,
                        300px 204px,
                        300px 204px,
                        300px 204px,
                        300px 134px,
                        300px 134px,
                        300px 134px,
                        300px 179px,
                        300px 179px,
                        300px 179px,
                        300px 299px,
                        300px 299px,
                        300px 299px,
                        300px 215px,
                        300px 215px,
                        300px 215px,
                        300px 281px,
                        300px 281px,
                        300px 281px,
                        300px 158px,
                        300px 158px,
                        300px 158px,
                        300px 210px,
                        300px 210px,
                        300px 210px;
                    animation: hi 150s linear infinite;
                }

                @keyframes hi {
                    0% {
                        background-position:
                            0px 220px,
                            3px 220px,
                            151.5px 337.5px,
                            25px 24px,
                            28px 24px,
                            176.5px 150px,
                            50px 16px,
                            53px 16px,
                            201.5px 91px,
                            75px 224px,
                            78px 224px,
                            226.5px 350.5px,
                            100px 19px,
                            103px 19px,
                            251.5px 121px,
                            125px 120px,
                            128px 120px,
                            276.5px 187px,
                            150px 31px,
                            153px 31px,
                            301.5px 120.5px,
                            175px 235px,
                            178px 235px,
                            326.5px 384.5px,
                            200px 121px,
                            203px 121px,
                            351.5px 228.5px,
                            225px 224px,
                            228px 224px,
                            376.5px 364.5px,
                            250px 26px,
                            253px 26px,
                            401.5px 105px,
                            275px 75px,
                            278px 75px,
                            426.5px 180px;
                    }
                    to {
                        background-position:
                            0px 6800px,
                            3px 6800px,
                            151.5px 6917.5px,
                            25px 13632px,
                            28px 13632px,
                            176.5px 13758px,
                            50px 5416px,
                            53px 5416px,
                            201.5px 5491px,
                            75px 17175px,
                            78px 17175px,
                            226.5px 17301.5px,
                            100px 5119px,
                            103px 5119px,
                            251.5px 5221px,
                            125px 8428px,
                            128px 8428px,
                            276.5px 8495px,
                            150px 9876px,
                            153px 9876px,
                            301.5px 9965.5px,
                            175px 13391px,
                            178px 13391px,
                            326.5px 13540.5px,
                            200px 14741px,
                            203px 14741px,
                            351.5px 14848.5px,
                            225px 18770px,
                            228px 18770px,
                            376.5px 18910.5px,
                            250px 5082px,
                            253px 5082px,
                            401.5px 5161px,
                            275px 6375px,
                            278px 6375px,
                            426.5px 6480px;
                    }
                }
    </style>
</head>
<body class="min-h-screen font-inter">
    <span id="porId" data-por-id="{{ por.id }}" style="display: none;"></span>
    <!-- Background layer -->
    <div class="{% if company == 'a&p' %}a-and-p-background{% else %}fdec-rain-background{% endif %} fixed inset-0 z-0"></div>
    <div class="relative z-10 flex min-h-screen">
        {% include '_sidebar.html' %}

        <!-- Main Content -->
    <main class="flex-1 p-8 ml-20">
            <!-- Header -->
            <div class="mb-8">
                <div class="flex items-center justify-between mb-4">
                    <div>
                        <h1 class="text-4xl font-bold {% if company == 'fdec' %}text-gray-100{% else %}text-gray-900{% endif %} mb-2">POR Details</h1>
                        <p class="{% if company == 'fdec' %}text-gray-300{% else %}text-gray-600{% endif %} text-lg">Purchase Order Request ID: {{ por.id }}</p>
                    </div>
                    <div class="flex space-x-3">
                        <a href="{{ url_for('routes.view') }}" class="px-6 py-3 {% if company == 'fdec' %}bg-gray-800 text-gray-100 border border-gray-700{% else %}bg-gray-100 text-gray-700 border border-gray-200{% endif %} font-semibold rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 hover:scale-105 flex items-center space-x-2">
                            <i class="fas fa-arrow-left"></i>
                            <span>Back to Records</span>
                        </a>
                        <a href="{{ url_for('routes.attach_files', por_id=por.id) }}" class="px-6 py-3 bg-gradient-to-r from-blue-500 to-blue-600 {% if company == 'fdec' %}text-gray-100{% else %}text-gray-900{% endif %} font-semibold rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 hover:scale-105">
                            <i class="fas fa-paperclip mr-2"></i>
                            <span>Attach Files</span>
                        </a>
                    </div>
                </div>
            </div>

            <!-- POR Data Grid -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-12">
                <!-- Basic Information Card -->
                <div class="{% if company == 'fdec' %}bg-gray-900/80 backdrop-blur-xl{% else %}bg-gray-100/80 backdrop-blur-xl{% endif %} rounded-2xl p-6 shadow-xl border {% if company == 'fdec' %}border-gray-700{% else %}border-gray-200/50{% endif %} por-card mb-12">
                    <div class="flex items-center mb-4">
                        <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl flex items-center justify-center {% if company == 'fdec' %}text-gray-100{% else %}text-gray-900{% endif %} mr-3">
                            <i class="fas fa-info-circle"></i>
                        </div>
                        <h2 class="text-xl font-bold {% if company == 'fdec' %}text-gray-100{% else %}text-gray-900{% endif %}">Basic Information</h2>
                    </div>
                    <div class="space-y-4">
                        <div class="flex justify-between items-center p-3 {% if company == 'fdec' %}bg-gray-800{% else %}bg-gray-50{% endif %} rounded-xl">
                            <span class="{% if company == 'fdec' %}text-gray-300{% else %}text-gray-600{% endif %} font-medium">Ship/Project Name</span>
                            <div class="flex items-center space-x-2">
                                <span id="ship_project_name_{{ por.id }}" data-field="ship_project_name" data-por-id="{{ por.id }}" class="editable-field {% if company == 'fdec' %}text-gray-100{% else %}text-gray-900{% endif %} font-semibold cursor-pointer hover:text-blue-400 hover:underline transition-colors duration-200" title="Click to edit">{{ (por.ship_project_name or 'Not specified')|title }}</span>
                                <button data-copy-text="{{ por.ship_project_name or 'Not specified' }}" class="copy-btn text-blue-400 hover:text-blue-600 transition-colors duration-200">
                                    <i class="fas fa-copy"></i>
                                </button>
                            </div>
                        </div>
                        <div class="flex justify-between items-center p-3 bg-gray-50 rounded-xl">
                            <span class="text-gray-600 font-medium">Supplier</span>
                            <div class="flex items-center space-x-2">
                                <span id="supplier_{{ por.id }}" data-field="supplier" data-por-id="{{ por.id }}" class="editable-field text-gray-900 font-semibold cursor-pointer hover:text-blue-600 hover:underline transition-colors duration-200" title="Click to edit">{{ (por.supplier or 'Not specified')|title }}</span>
                                <button data-copy-text="{{ por.supplier or 'Not specified' }}" class="copy-btn text-blue-600 hover:text-blue-800 transition-colors duration-200">
                                    <i class="fas fa-copy"></i>
                                </button>
                            </div>
                        </div>
                        <div class="flex justify-between items-center p-3 bg-gray-50 rounded-xl">
                            <span class="text-gray-600 font-medium">Requestor Name</span>
                            <div class="flex items-center space-x-2">
                                <span id="requestor_name_{{ por.id }}" data-field="requestor_name" data-por-id="{{ por.id }}" class="editable-field text-gray-900 font-semibold cursor-pointer hover:text-blue-600 hover:underline transition-colors duration-200" title="Click to edit">{{ (por.requestor_name or 'Not specified')|title }}</span>
                                <button data-copy-text="{{ por.requestor_name or 'Not specified' }}" class="copy-btn text-blue-600 hover:text-blue-800 transition-colors duration-200">
                                    <i class="fas fa-copy"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="p-3 bg-gray-50 rounded-xl">
                            <label class="block text-gray-600 font-medium mb-2">Order Type</label>
                            <select id="orderTypeSelect" onchange="updateOrderType('{{ por.id }}', this.value)" class="w-full p-3 border border-gray-300 rounded-xl bg-gray-100 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <option value="new" {% if por.order_type == 'new' %}selected{% endif %}>New Order</option>
                                <option value="revised" {% if por.order_type == 'revised' %}selected{% endif %}>Revised Order</option>
                                <option value="cancelled" {% if por.order_type == 'cancelled' %}selected{% endif %}>Cancelled Order</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Financial Information Card -->
                <div class="bg-gray-100/80 backdrop-blur-xl rounded-2xl p-6 shadow-xl border border-gray-200/50 por-card mb-12">
                    <div class="flex items-center mb-4">
                        <div class="w-10 h-10 bg-gradient-to-br from-green-500 to-green-600 rounded-xl flex items-center justify-center text-gray-900 mr-3">
                            <i class="fas fa-pound-sign"></i>
                        </div>
                        <h2 class="text-xl font-bold text-gray-900">Financial Details</h2>
                    </div>
                    <div class="space-y-4">
                        <div class="flex justify-between items-center p-3 bg-gray-50 rounded-xl">
                            <span class="text-gray-600 font-medium">Order Total</span>
                            <div class="flex items-center space-x-2">
                                <span id="order_total_{{ por.id }}" data-field="order_total" data-por-id="{{ por.id }}" class="editable-field text-gray-900 font-bold text-lg cursor-pointer hover:text-blue-600 hover:underline transition-colors duration-200" title="Click to edit">£{{ "%.2f"|format(por.order_total or 0) }}</span>
                                <button data-copy-text="£{{ "%.2f"|format(por.order_total or 0) }}" class="copy-btn text-blue-600 hover:text-blue-800 transition-colors duration-200">
                                    <i class="fas fa-copy"></i>
                                </button>
                            </div>
                        </div>
                        <div class="flex justify-between items-center p-3 bg-gray-50 rounded-xl">
                            <span class="text-gray-600 font-medium">Date Order Raised</span>
                            <div class="flex items-center space-x-2">
                                <span id="date_order_raised_{{ por.id }}" data-field="date_order_raised" data-por-id="{{ por.id }}" class="editable-field text-gray-900 font-semibold cursor-pointer hover:text-blue-600 hover:underline transition-colors duration-200" title="Click to edit">{{ por.date_order_raised or 'Not specified' }}</span>
                                <button data-copy-text="{{ por.date_order_raised or 'Not specified' }}" class="copy-btn text-blue-600 hover:text-blue-800 transition-colors duration-200">
                                    <i class="fas fa-copy"></i>
                                </button>
                            </div>
                        </div>
                        <div class="flex justify-between items-center p-3 bg-gray-50 rounded-xl">
                            <span class="text-gray-600 font-medium">Date Required By</span>
                            <div class="flex items-center space-x-2">
                                <span id="date_required_by_{{ por.id }}" data-field="date_required_by" data-por-id="{{ por.id }}" class="editable-field text-gray-900 font-semibold cursor-pointer hover:text-blue-600 hover:underline transition-colors duration-200" title="Click to edit">{{ por.date_required_by or 'Not specified' }}</span>
                                <button data-copy-text="{{ por.date_required_by or 'Not specified' }}" class="copy-btn text-blue-600 hover:text-blue-800 transition-colors duration-200">
                                    <i class="fas fa-copy"></i>
                                </button>
                            </div>
                        </div>
                        <div class="flex justify-between items-center p-3 bg-gray-50 rounded-xl">
                            <span class="text-gray-600 font-medium">Show Price</span>
                            <div class="flex items-center space-x-2">
                                <span id="show_price_{{ por.id }}" data-field="show_price" data-por-id="{{ por.id }}" class="editable-field text-gray-900 font-semibold cursor-pointer hover:text-blue-600 hover:underline transition-colors duration-200" title="Click to edit">{{ por.show_price or 'Not specified' }}</span>
                                <button data-copy-text="{{ por.show_price or 'Not specified' }}" class="copy-btn text-blue-600 hover:text-blue-800 transition-colors duration-200">
                                    <i class="fas fa-copy"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Timeline & Stage Management Card -->
            <div class="bg-gray-100/80 backdrop-blur-xl rounded-2xl p-6 shadow-xl border border-gray-200/50 por-card mb-12">
                <div class="flex items-center mb-4">
                    <div class="w-10 h-10 bg-gradient-to-br from-purple-500 to-purple-600 rounded-xl flex items-center justify-center text-gray-900 mr-3">
                        <i class="fas fa-clock"></i>
                    </div>
                    <h2 class="text-xl font-bold text-gray-900">Timeline & Stage Management</h2>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div class="p-4 bg-gray-50 rounded-xl relative">
                        <label class="block text-gray-600 font-medium mb-2">Current Stage</label>
                        <select id="stageSelect" onchange="updateStage('{{ por.id }}', this.value)" class="w-full p-3 border border-gray-300 rounded-xl bg-gray-100 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="received" {% if por.current_stage == 'received' %}selected{% endif %}>Received</option>
                            <option value="sent" {% if por.current_stage == 'sent' %}selected{% endif %}>Sent</option>
                            <option value="filed" {% if por.current_stage == 'filed' %}selected{% endif %}>Filed</option>
                        </select>
                    </div>
                    <div class="p-4 bg-gray-50 rounded-xl">
                        <label class="block text-gray-600 font-medium mb-2">Content Type</label>
                        <select id="contentTypeSelect" onchange="updateContentType('{{ por.id }}', this.value)" class="w-full p-3 border border-gray-300 rounded-xl bg-gray-100 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="work_iwo" {% if por.content_type == 'work_iwo' %}selected{% endif %}>Work IWO</option>
                            <option value="supply_and_fit" {% if por.content_type == 'supply_and_fit' %}selected{% endif %}>Supply & Fit</option>
                            <option value="supply" {% if por.content_type == 'supply' %}selected{% endif %}>Supply Only</option>
                        </select>
                    </div>
                    <div class="p-4 bg-gray-50 rounded-xl">
                        <label class="block text-gray-600 font-medium mb-2">Created</label>
                        <div class="flex items-center justify-between">
                            <span id="created_at_{{ por.id }}" data-field="created_at" data-por-id="{{ por.id }}" class="editable-field text-gray-900 font-semibold cursor-pointer hover:text-blue-600 hover:underline transition-colors duration-200" title="Click to edit">{{ por.created_at.strftime('%d/%m/%Y %H:%M') if por.created_at else 'Not specified' }}</span>
                            <button data-copy-text="{{ por.created_at.strftime('%d/%m/%Y %H:%M') if por.created_at else 'Not specified' }}" class="copy-btn text-blue-600 hover:text-blue-800 transition-colors duration-200">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quote & Contact Information Card -->
            <div class="bg-gray-100/80 backdrop-blur-xl rounded-2xl p-6 shadow-xl border border-gray-200/50 por-card mb-12">
                <div class="flex items-center mb-4">
                    <div class="w-10 h-10 bg-gradient-to-br from-orange-500 to-orange-600 rounded-xl flex items-center justify-center text-gray-900 mr-3">
                        <i class="fas fa-phone"></i>
                    </div>
                    <h2 class="text-xl font-bold text-gray-900">Quote & Contact Information</h2>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="p-4 bg-gray-50 rounded-xl">
                        <label class="block text-gray-600 font-medium mb-2">Quote Reference</label>
                        <div class="flex items-center justify-between">
                            <span id="quote_ref_{{ por.id }}" data-field="quote_ref" data-por-id="{{ por.id }}" class="editable-field text-gray-900 font-semibold cursor-pointer hover:text-blue-600 hover:underline transition-colors duration-200" title="Click to edit">{{ (por.quote_ref or 'Not specified')|title }}</span>
                            <button data-copy-text="{{ por.quote_ref or 'Not specified' }}" class="copy-btn text-blue-600 hover:text-blue-800 transition-colors duration-200">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                    </div>
                    <div class="p-4 bg-gray-50 rounded-xl">
                        <label class="block text-gray-600 font-medium mb-2">Quote Date</label>
                        <div class="flex items-center justify-between">
                            <span id="quote_date_{{ por.id }}" data-field="quote_date" data-por-id="{{ por.id }}" class="editable-field text-gray-900 font-semibold cursor-pointer hover:text-blue-600 hover:underline transition-colors duration-200" title="Click to edit">{{ (por.quote_date or 'Not specified')|title }}</span>
                            <button data-copy-text="{{ por.quote_date or 'Not specified' }}" class="copy-btn text-blue-600 hover:text-blue-800 transition-colors duration-200">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                    </div>
                    <div class="p-4 bg-gray-50 rounded-xl">
                        <label class="block text-gray-600 font-medium mb-2">Supplier Contact Name</label>
                        <div class="flex items-center justify-between">
                            <span id="supplier_contact_name_{{ por.id }}" data-field="supplier_contact_name" data-por-id="{{ por.id }}" class="editable-field text-gray-900 font-semibold cursor-pointer hover:text-blue-600 hover:underline transition-colors duration-200" title="Click to edit">{{ (por.supplier_contact_name or 'Not specified')|title }}</span>
                            <button data-copy-text="{{ por.supplier_contact_name or 'Not specified' }}" class="copy-btn text-blue-600 hover:text-blue-800 transition-colors duration-200">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                    </div>
                    <div class="p-4 bg-gray-50 rounded-xl">
                        <label class="block text-gray-600 font-medium mb-2">Supplier Contact Email</label>
                        <div class="flex items-center justify-between">
                            <span id="supplier_contact_email_{{ por.id }}" data-field="supplier_contact_email" data-por-id="{{ por.id }}" class="editable-field text-gray-900 font-semibold cursor-pointer hover:text-blue-600 hover:underline transition-colors duration-200" title="Click to edit">{{ (por.supplier_contact_email or 'Not specified')|title }}</span>
                            <button data-copy-text="{{ por.supplier_contact_email or 'Not specified' }}" class="copy-btn text-blue-600 hover:text-blue-800 transition-colors duration-200">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Specifications & Requirements Card -->
            <div class="bg-gray-100/80 backdrop-blur-xl rounded-2xl p-6 shadow-xl border border-gray-200/50 por-card mb-12">
                <div class="flex items-center mb-4">
                    <div class="w-10 h-10 bg-gradient-to-br from-indigo-500 to-indigo-600 rounded-xl flex items-center justify-center text-gray-900 mr-3">
                        <i class="fas fa-clipboard-list"></i>
                    </div>
                    <h2 class="text-xl font-bold text-gray-900">Specifications & Requirements</h2>
                </div>
                <div class="p-4 bg-gray-50 rounded-xl">
                    <label class="block text-gray-600 font-medium mb-2">Specification/Standards</label>
                    <div class="flex items-start justify-between">
                        <span id="specification_standards_{{ por.id }}" data-field="specification_standards" data-por-id="{{ por.id }}" class="editable-field text-gray-900 font-semibold flex-1 mr-4 cursor-pointer hover:text-blue-600 hover:underline transition-colors duration-200" title="Click to edit">{{ por.specification_standards or 'Not specified' }}</span>
                        <button data-copy-text="{{ por.specification_standards or 'Not specified' }}" class="copy-btn text-blue-600 hover:text-blue-800 transition-colors duration-200 flex-shrink-0">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Line Items Card -->
            <div class="bg-gray-100/80 backdrop-blur-xl rounded-2xl p-6 shadow-xl border border-gray-200/50 por-card mb-12">
                <div class="flex items-center mb-4">
                    <div class="w-10 h-10 bg-gradient-to-br from-teal-500 to-teal-600 rounded-xl flex items-center justify-center text-gray-900 mr-3">
                        <i class="fas fa-boxes"></i>
                    </div>
                    <h2 class="text-xl font-bold text-gray-900">Line Items</h2>
                </div>
                {% if por.job_contract_no or por.description %}
                <div class="overflow-x-auto">
                    <table class="min-w-full">
                        <thead>
                            <tr class="border-b border-gray-200">
                                <th class="text-left py-3 px-4 text-sm font-semibold text-gray-600">Item</th>
                                <th class="text-left py-3 px-4 text-sm font-semibold text-gray-600">Job/Contract No</th>
                                <th class="text-left py-3 px-4 text-sm font-semibold text-gray-600">OP No</th>
                                <th class="text-left py-3 px-4 text-sm font-semibold text-gray-600">Description</th>
                                <th class="text-left py-3 px-4 text-sm font-semibold text-gray-600">Quantity</th>
                                <th class="text-left py-3 px-4 text-sm font-semibold text-gray-600">Unit Price</th>
                                <th class="text-left py-3 px-4 text-sm font-semibold text-gray-600">Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr class="border-b border-gray-200">
                                <td class="py-3 px-4 text-sm text-gray-900">1</td>
                                <td class="py-3 px-4 text-sm text-gray-900">
                                    <div class="flex items-center justify-between">
                                        <span id="job_contract_no_{{ por.id }}" data-field="job_contract_no" data-por-id="{{ por.id }}" class="editable-field cursor-pointer hover:text-blue-600 hover:underline transition-colors duration-200" title="Click to edit">{{ (por.job_contract_no or 'N/A')|title }}</span>
                                        <button data-copy-text="{{ por.job_contract_no or 'N/A' }}" class="copy-btn text-blue-600 hover:text-blue-800 transition-colors duration-200 ml-2">
                                            <i class="fas fa-copy text-xs"></i>
                                        </button>
                                    </div>
                                </td>
                                <td class="py-3 px-4 text-sm text-gray-900">
                                    <div class="flex items-center justify-between">
                                        <span id="op_no_{{ por.id }}" data-field="op_no" data-por-id="{{ por.id }}" class="editable-field cursor-pointer hover:text-blue-600 hover:underline transition-colors duration-200" title="Click to edit">{{ (por.op_no or 'N/A')|title }}</span>
                                        <button data-copy-text="{{ por.op_no or 'N/A' }}" class="copy-btn text-blue-600 hover:text-blue-800 transition-colors duration-200 ml-2">
                                            <i class="fas fa-copy text-xs"></i>
                                        </button>
                                    </div>
                                </td>
                                <td class="py-3 px-4 text-sm text-gray-900">
                                    <span id="desc_{{ por.id }}" data-field="description" data-por-id="{{ por.id }}" class="editable-field cursor-pointer text-blue-600 hover:text-blue-800 underline" title="Click to edit">{{ (por.description or 'No description')|title }}</span>
                                </td>
                                <td class="py-3 px-4 text-sm text-gray-900">
                                    <span id="quantity_{{ por.id }}" data-field="quantity" data-por-id="{{ por.id }}" class="editable-field cursor-pointer hover:text-blue-600 hover:underline transition-colors duration-200" title="Click to edit">{{ por.quantity or 1 }}</span>
                                </td>
                                <td class="py-3 px-4 text-sm text-gray-900">
                                    <span id="price_each_{{ por.id }}" data-field="price_each" data-por-id="{{ por.id }}" class="editable-field cursor-pointer hover:text-blue-600 hover:underline transition-colors duration-200" title="Click to edit">£{{ "%.2f"|format(por.price_each or 0) }}</span>
                                </td>
                                <td class="py-3 px-4 text-sm text-gray-900 font-semibold">£{{ "%.2f"|format((por.quantity or 1) * (por.price_each or 0)) }}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-12 text-gray-400">
                    <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-box-open text-2xl text-gray-400"></i>
                    </div>
                    <p class="text-lg font-medium">No line items found for this POR</p>
                </div>
                {% endif %}
            </div>

            <!-- New File Upload Card -->
            <div class="bg-gray-100/80 backdrop-blur-xl rounded-2xl p-6 shadow-xl border border-gray-200/50 por-card mb-12">
                <h2 class="text-xl font-bold text-gray-900 mb-4 flex items-center">
                    <i class="fas fa-upload text-blue-500 mr-2"></i>
                    Upload New Files
                </h2>
                <form method="post" enctype="multipart/form-data" id="inlineUploadForm">
                    <div class="border-2 border-dashed border-gray-300 rounded-xl p-8 text-center transition-all duration-300 hover:border-blue-400 hover:bg-blue-50" 
                         id="inlineDragArea" 
                         ondragover="handleInlineDragOver(event)" 
                         ondragleave="handleInlineDragLeave(event)" 
                         ondrop="handleInlineDrop(event)">
                        <div class="space-y-4">
                            <i class="fas fa-cloud-upload-alt text-4xl text-blue-500"></i>
                            <h3 class="text-lg font-semibold text-gray-900">Drag & Drop Files Here</h3>
                            <p class="text-gray-600">or click to browse files</p>
                            <p class="text-sm text-blue-400 font-medium">💡 You can select multiple files and add more later!</p>
                            <input type="file" name="files" multiple accept=".pdf,.doc,.docx,.xls,.xlsx,.xlsm,.xltx,.xltm,.xlt,.xlm,.jpg,.jpeg,.png,.msg,.eml" style="display: none;" id="inlineFileInput" onchange="handleInlineFileSelect(this.files)">
                            <button type="button" data-target-input="inlineFileInput" class="browse-btn px-6 py-3 bg-blue-500 text-gray-900 font-semibold rounded-xl hover:bg-blue-600 transition-colors duration-200">
                                Browse Files
                            </button>
                        </div>
                    </div>
                    
                    <div id="inlineFileList" style="display: none;" class="mt-6">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center space-x-3">
                                <h3 class="text-lg font-semibold text-gray-900">Selected Files:</h3>
                                <span id="inlineFileCounter" class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm font-medium">0</span>
                            </div>
                            <button type="button" class="clear-all-btn px-4 py-2 text-gray-600 hover:text-gray-900 transition-colors duration-200 flex items-center space-x-2">
                                <i class="fas fa-trash"></i>
                                <span>Clear All</span>
                            </button>
                        </div>
                        <div id="inlineFileItems"></div>
                    </div>
                    
                    <button type="submit" class="w-full px-8 py-4 bg-gradient-to-r from-green-500 to-green-600 text-gray-900 font-semibold rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 hover:scale-105 flex items-center justify-center space-x-2 mt-6" id="inlineUploadBtn" style="display: none;">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <span>Upload Selected Files</span>
                    </button>
                </form>
            </div>

            <!-- Attached Files Card -->
            <div class="bg-gray-100/80 backdrop-blur-xl rounded-2xl p-6 shadow-xl border border-gray-200/50 por-card mb-12">
                <div class="flex items-center mb-4">
                    <div class="w-10 h-10 bg-gradient-to-br from-pink-500 to-pink-600 rounded-xl flex items-center justify-center text-gray-900 mr-3">
                        <i class="fas fa-paperclip"></i>
                    </div>
                    <h2 class="text-xl font-bold text-gray-900">Attached Files</h2>
                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    {% if por.files %}
                        {% for file in por.files %}
                        <div class="bg-gray-50 rounded-xl p-4 border border-gray-200/50">
                                                            <p class="text-sm font-semibold text-gray-900 truncate">{{ file.filename }}</p>
                                <p class="text-xs text-gray-400 capitalize">{{ file.description }}</p>
                                <p class="text-xs text-gray-400">{{ file.uploaded_at.strftime('%d/%m/%Y %H:%M') if file.uploaded_at else 'Unknown date' }}</p>
                            <div class="flex space-x-2">
                                <a href="{{ url_for('routes.view_file', file_id=file.id) }}" target="_blank" class="flex-1 bg-gradient-to-r from-blue-500 to-blue-600 text-gray-900 text-xs px-3 py-2 rounded-lg hover:shadow-lg transition-all duration-300 text-center font-medium">
                                    <i class="fas fa-download mr-1"></i>
                                    Download
                                </a>
                                <button data-file-id="{{ file.id }}" class="delete-file-btn px-3 py-2 bg-red-500 text-gray-900 text-xs rounded-lg hover:bg-red-600 transition-colors duration-300">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                    <div class="text-center py-12 text-gray-400 col-span-full">
                        <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-paperclip text-2xl text-gray-400"></i>
                        </div>
                        <p class="text-lg font-medium mb-4">No files attached to this POR</p>
                    </div>
                    {% endif %}
                </div>

            <!-- Email Subject Line Card -->
            <div class="bg-gray-100/80 backdrop-blur-xl rounded-2xl p-6 shadow-xl border border-gray-200/50 por-card mb-12">
                <div class="flex items-center mb-4">
                    <div class="w-10 h-10 bg-gradient-to-br from-emerald-500 to-emerald-600 rounded-xl flex items-center justify-center text-gray-900 mr-3">
                        <i class="fas fa-envelope"></i>
                    </div>
                    <h2 class="text-xl font-bold text-gray-900">Email Subject Line</h2>
                </div>
                <div class="p-4 bg-gray-50 rounded-xl">
                    <label class="block text-gray-600 font-medium mb-2">Generated Subject</label>
                    <div class="flex items-center justify-between">
                        <span id="emailSubject" class="text-gray-900 font-semibold text-lg">
                            {{ (por.order_type or 'New Order')|title|replace('_', ' ') }} | {{ (por.supplier or 'Supplier')|title }} | {{ (por.ship_project_name or 'Project Name')|title }} | PO {{ por.id }}
                        </span>
                        <button data-copy-target="emailSubject" class="copy-target-btn text-blue-600 hover:text-blue-800 transition-colors duration-200">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Copy to Clipboard Feedback -->
    <div id="copyFeedback" class="fixed top-6 right-6 bg-green-500 text-gray-900 px-6 py-3 rounded-xl shadow-xl transform translate-x-full transition-transform duration-300 z-50 opacity-0 pointer-events-none">
        <div class="flex items-center space-x-2">
            <i class="fas fa-check"></i>
            <span>Copied to clipboard!</span>
        </div>
    </div>

    <!-- Edit Modal -->
    <div id="editModal" class="fixed inset-0 bg-black/50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-20 mx-auto p-8 border-gray-200/50 w-full max-w-2xl shadow-2xl rounded-2xl bg-gray-100/80 backdrop-blur-xl">
            <div class="mb-6">
                <h3 class="text-2xl font-bold text-gray-900">Edit Field</h3>
                <p class="text-gray-600 mt-2">Update the value for this field</p>
            </div>
            <textarea id="editTextarea" class="w-full p-4 border-2 border-gray-200/50 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none" rows="4" placeholder="Enter value..."></textarea>
            <div class="flex justify-end space-x-3 mt-6">
                <button class="close-modal-btn px-6 py-3 bg-gray-100 text-gray-900 font-semibold rounded-xl hover:bg-gray-400 transition-colors duration-300">
                    Cancel
                </button>
                <button class="save-edit-btn px-6 py-3 bg-gradient-to-r from-blue-500 to-blue-600 text-gray-900 font-semibold rounded-xl hover:shadow-lg transition-all duration-300">
                    Save Changes
                </button>
            </div>
        </div>
    </div>

    <script>
        let currentEditId = null;
        let currentEditField = null;

        // Copy to clipboard function
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(function() {
                const feedback = document.getElementById('copyFeedback');
                feedback.classList.remove('translate-x-full', 'opacity-0', 'pointer-events-none');
                setTimeout(() => {
                    feedback.classList.add('translate-x-full', 'opacity-0', 'pointer-events-none');
                }, 2000);
            });
        }

        // Make editable function
        function makeEditable(elementId, fieldName) {
            const element = document.getElementById(elementId);
            const currentText = element.textContent;
            
            currentEditId = elementId;
            currentEditField = fieldName;
            
            const textarea = document.getElementById('editTextarea');
            textarea.value = currentText;
            
            document.getElementById('editModal').classList.remove('hidden');
        }

        // Initialize event listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Handle navigation buttons
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const url = this.dataset.navUrl;
                    if (url) {
                        window.location.href = url;
                    }
                });
            });

            // Handle copy buttons
            document.querySelectorAll('.copy-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const text = this.dataset.copyText;
                    if (text) {
                        copyToClipboard(text);
                    }
                });
            });

            // Handle copy target buttons
            document.querySelectorAll('.copy-target-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const targetId = this.dataset.copyTarget;
                    if (targetId) {
                        const targetElement = document.getElementById(targetId);
                        if (targetElement) {
                            copyToClipboard(targetElement.textContent);
                        }
                    }
                });
            });

            // Handle browse buttons
            document.querySelectorAll('.browse-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const inputId = this.dataset.targetInput;
                    if (inputId) {
                        const input = document.getElementById(inputId);
                        if (input) {
                            input.click();
                        }
                    }
                });
            });

            // Handle clear all button
            document.querySelectorAll('.clear-all-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    clearAllInlineFiles();
                });
            });

            // Handle delete file buttons
            document.querySelectorAll('.delete-file-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const fileId = this.dataset.fileId;
                    if (fileId) {
                        deleteFile(fileId);
                    }
                });
            });

            // Handle remove file buttons
            document.querySelectorAll('.remove-file-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const index = parseInt(this.dataset.fileIndex);
                    if (!isNaN(index)) {
                        removeInlineFile(index);
                    }
                });
            });

            // Handle editable fields
            document.querySelectorAll('.editable-field').forEach(field => {
                field.addEventListener('click', function() {
                    const fieldId = this.id;
                    const fieldName = this.dataset.field;
                    makeEditable(fieldId, fieldName);
                });
            });

            // Handle modal buttons
            document.querySelectorAll('.close-modal-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    closeEditModal();
                });
            });

            document.querySelectorAll('.save-edit-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    saveEdit();
                });
            });
        });

        function closeEditModal() {
            document.getElementById('editModal').classList.add('hidden');
            currentEditId = null;
            currentEditField = null;
        }

        function saveEdit() {
            const newText = document.getElementById('editTextarea').value;
            const element = document.getElementById(currentEditId);
            element.textContent = newText;
            
            // Here you would typically send the update to the server
            // For now, we'll just update the display
            closeEditModal();
        }

        function deleteFile(fileId) {
            if (confirm('Are you sure you want to delete this file?')) {
                fetch(`/delete_file/${fileId}`, {
                    method: 'DELETE',
                }).then(response => {
                    if (response.ok) {
                        location.reload();
                    } else {
                        alert('Error deleting file');
                    }
                });
            }
        }

        function updateStage(porId, newStage) {
            fetch(`/update_timeline_stage`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ 
                    por_id: porId, 
                    stage: newStage 
                })
            }).then(response => {
                if (response.ok) {
                    return response.json();
                } else {
                    throw new Error('Network response was not ok');
                }
            }).then(data => {
                if (data.success) {
                    // Show success feedback
                    const feedback = document.getElementById('copyFeedback');
                    feedback.innerHTML = '<div class="flex items-center space-x-2"><i class="fas fa-check"></i><span>Stage updated successfully!</span></div>';
                    feedback.classList.remove('translate-x-full');
                    setTimeout(() => {
                        feedback.classList.add('translate-x-full');
                    }, 2000);

                    // Apply the new style if the stage is 'filed'
                    if (newStage === 'filed') {
                        const mainContent = document.querySelector('main');
                        mainContent.classList.add('filed-stage');
                        const cards = mainContent.querySelectorAll('.por-card');
                        cards.forEach(card => {
                            card.classList.add('filed-stage-inner');
                        });
                    } else {
                        const mainContent = document.querySelector('main');
                        mainContent.classList.remove('filed-stage');
                        const cards = mainContent.querySelectorAll('.por-card');
                        cards.forEach(card => {
                            card.classList.remove('filed-stage-inner');
                        });
                    }
                } else {
                    alert('Error updating stage: ' + (data.error || 'Unknown error'));
                }
            }).catch(error => {
                console.error('Error:', error);
                alert('Error updating stage: ' + error.message);
            });
        }

        function updateContentType(porId, newContentType) {
            fetch(`/update_content_type`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ 
                    por_id: porId, 
                    content_type: newContentType 
                })
            }).then(response => {
                if (response.ok) {
                    return response.json();
                } else {
                    throw new Error('Network response was not ok');
                }
            }).then(data => {
                if (data.success) {
                    // Show success feedback
                    const feedback = document.getElementById('copyFeedback');
                    feedback.innerHTML = '<div class="flex items-center space-x-2"><i class="fas fa-check"></i><span>Content type updated successfully!</span></div>';
                    feedback.classList.remove('translate-x-full');
                    setTimeout(() => {
                        feedback.classList.add('translate-x-full');
                    }, 2000);
                    
                    // Update email subject line
                    updateEmailSubject();
                    
                    // Apply work order logic
                    applyWorkOrderLogic(newContentType);
                } else {
                    alert('Error updating content type: ' + (data.error || 'Unknown error'));
                }
            }).catch(error => {
                console.error('Error:', error);
                alert('Error updating content type: ' + error.message);
            });
        }
        
        function updateCompany(porId, newCompany) {
            fetch(`/update_company`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ 
                    por_id: porId, 
                    company: newCompany 
                })
            }).then(response => {
                if (response.ok) {
                    return response.json();
                } else {
                    throw new Error('Network response was not ok');
                }
            }).then(data => {
                if (data.success) {
                    // Show success feedback
                    const feedback = document.getElementById('copyFeedback');
                    feedback.innerHTML = '<div class="flex items-center space-x-2"><i class="fas fa-check"></i><span>Company updated successfully!</span></div>';
                    feedback.classList.remove('translate-x-full', 'opacity-0', 'pointer-events-none');
                    setTimeout(() => {
                        feedback.classList.add('translate-x-full', 'opacity-0', 'pointer-events-none');
                    }, 2000);
                } else {
                    alert('Error updating company: ' + (data.error || 'Unknown error'));
                }
            }).catch(error => {
                console.error('Error:', error);
                alert('Error updating company: ' + error.message);
            });
        }
        
        function updateOrderType(porId, newOrderType) {
            fetch(`/update_order_type`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ 
                    por_id: porId, 
                    order_type: newOrderType 
                })
            }).then(response => {
                if (response.ok) {
                    return response.json();
                } else {
                    throw new Error('Network response was not ok');
                }
            }).then(data => {
                if (data.success) {
                    // Show success feedback
                    const feedback = document.getElementById('copyFeedback');
                    feedback.innerHTML = '<div class="flex items-center space-x-2"><i class="fas fa-check"></i><span>Order type updated successfully!</span></div>';
                    feedback.classList.remove('translate-x-full', 'opacity-0', 'pointer-events-none');
                    setTimeout(() => {
                        feedback.classList.add('translate-x-full', 'opacity-0', 'pointer-events-none');
                    }, 2000);
                    
                    // Update email subject line
                    updateEmailSubject();
                } else {
                    alert('Error updating order type: ' + (data.error || 'Unknown error'));
                }
            }).catch(error => {
                console.error('Error:', error);
                alert('Error updating order type: ' + error.message);
            });
        }
        
        function updateEmailSubject() {
            const orderType = document.getElementById('orderTypeSelect').value;
            const supplier = '{{ por.supplier or "Supplier" }}';
            const projectName = '{{ por.ship_project_name or "Project Name" }}';
            const poNumber = '{{ por.id }}';
            
            let orderTypeText = 'New Order';
            if (orderType === 'new') orderTypeText = 'New Order';
            else if (orderType === 'revised') orderTypeText = 'Revised Order';
            else if (orderType === 'cancelled') orderTypeText = 'Cancelled Order';
            
            const emailSubject = `${orderTypeText} | ${supplier} | ${projectName} | PO ${poNumber}`;
            document.getElementById('emailSubject').textContent = emailSubject;
        }
        
        function applyWorkOrderLogic(contentType) {
            const supplier = '{{ por.supplier or "" }}';
            const isEAPL = supplier.toLowerCase().includes('eapl');
            const descriptionElement = document.getElementById('desc_{{ por.id }}');
            
            if (!descriptionElement) {
                return;
            }

            let originalDescription = descriptionElement.textContent;

            // List of all possible prefixes (new and old) to remove before applying the correct one.
            const prefixes = [
                "Work I.W.O Supply and Fit - X",
                "Work I.W.O Supply and Fit -",
                "Work I.W.O",
                "Provide Labour I.W.O Supply and Fit - X",
                "Provide Labour I.W.O Supply and Fit -",
                "Provide Labour I.W.O",
                "Supply & Fit" // Old incorrect prefix
            ];

            // Remove any existing prefix to avoid duplication
            for (const p of prefixes) {
                if (originalDescription.startsWith(p + ' ')) {
                    originalDescription = originalDescription.substring(p.length + 1).trim();
                } else if (originalDescription.startsWith(p)) {
                    originalDescription = originalDescription.substring(p.length).trim();
                }
            }

            let prefix = '';
            if (isEAPL) {
                if (contentType === 'supply_and_fit') {
                    prefix = 'Provide Labour I.W.O Supply and Fit - ';
                } else if (contentType === 'work_iwo') {
                    prefix = 'Provide Labour I.W.O';
                }
            } else {
                if (contentType === 'supply_and_fit') {
                    prefix = 'Work I.W.O Supply and Fit - ';
                } else if (contentType === 'work_iwo') {
                    prefix = 'Work I.W.O';
                }
            }

            if (prefix) {
                if (prefix.endsWith(' ')) {
                    descriptionElement.textContent = `${prefix}${originalDescription}`;
                } else {
                    descriptionElement.textContent = `${prefix} ${originalDescription}`;
                }
            } else {
                descriptionElement.textContent = originalDescription;
            }
        }

        // Close modal when clicking outside
        document.getElementById('editModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeEditModal();
            }
        });
        
        

        let inlineSelectedFiles = [];

        function handleInlineFileSelect(files) {
            Array.from(files).forEach(file => {
                // Check for duplicates before adding
                const isDuplicate = inlineSelectedFiles.some(existingFile =>
                    existingFile.name === file.name && existingFile.size === file.size
                );
                if (!isDuplicate) {
                    inlineSelectedFiles.push(file);
                }
            });
            updateInlineFileList();
            updateInlineUploadButton();
        }

        function updateInlineFileList() {
            const fileListDiv = document.getElementById('inlineFileList');
            const fileItemsDiv = document.getElementById('inlineFileItems');
            const fileCounterSpan = document.getElementById('inlineFileCounter');

            if (inlineSelectedFiles.length === 0) {
                fileListDiv.style.display = 'none';
                return;
            }

            fileListDiv.style.display = 'block';
            fileCounterSpan.textContent = inlineSelectedFiles.length;

            fileItemsDiv.innerHTML = inlineSelectedFiles.map((file, index) => `
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg border border-gray-200/50 mb-2">
                    <div class="flex items-center space-x-3">
                        <i class="fas fa-file text-blue-400 text-lg"></i>
                        <div>
                            <p class="text-sm font-medium text-gray-900 truncate">${file.name}</p>
                            <p class="text-xs text-gray-400">${(file.size / 1024 / 1024).toFixed(2)} MB</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-2">
                        <select name="file_types" class="px-2 py-1 bg-gray-100 text-gray-900 text-xs rounded-md focus:ring-blue-500 focus:border-blue-500">
                            <option value="original">Original</option>
                            <option value="quote">Quote</option>
                            <option value="correspondence">Correspondence</option>
                            <option value="updates">Updates</option>
                            <option value="por">POR</option>
                            <option value="other" selected>Other</option>
                        </select>
                        <input type="text" name="descriptions" placeholder="Description (optional)" class="px-2 py-1 bg-gray-100 text-gray-900 text-xs rounded-md focus:ring-blue-500 focus:border-blue-500 flex-1 min-w-0">
                        <button type="button" data-file-index="${index}" class="remove-file-btn text-red-400 hover:text-red-600 transition-colors duration-200">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function removeInlineFile(index) {
            inlineSelectedFiles.splice(index, 1);
            updateInlineFileList();
            updateInlineUploadButton();
        }

        function clearAllInlineFiles() {
            inlineSelectedFiles = [];
            updateInlineFileList();
            updateInlineUploadButton();
            document.getElementById('inlineFileInput').value = ''; // Clear the file input
        }

        function updateInlineUploadButton() {
            const uploadBtn = document.getElementById('inlineUploadBtn');
            uploadBtn.style.display = inlineSelectedFiles.length > 0 ? 'flex' : 'none';
        }

        function handleInlineDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('border-blue-400', 'bg-blue-50');
        }

        function handleInlineDragLeave(e) {
            e.currentTarget.classList.remove('border-blue-400', 'bg-blue-50');
        }

        function handleInlineDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('border-blue-400', 'bg-blue-50');
            handleInlineFileSelect(e.dataTransfer.files);
        }

        // Handle inline form submission
        document.getElementById('inlineUploadForm').addEventListener('submit', function(e) {
            e.preventDefault();

            if (inlineSelectedFiles.length === 0) {
                alert('Please select files to upload.');
                return;
            }

            const formData = new FormData();
            
            // Iterate over selected files and append their data
            inlineSelectedFiles.forEach((file, index) => {
                formData.append('files', file);

                // Get the corresponding file type and description from the dynamically created elements
                const fileItemDiv = document.querySelector(`#inlineFileItems > div:nth-child(${index + 1})`);
                const fileTypeSelect = fileItemDiv.querySelector('select[name="file_types"]');
                const descriptionInput = fileItemDiv.querySelector('input[name="descriptions"]');

                const selectedFileType = fileTypeSelect ? fileTypeSelect.value : 'other';
                let description = descriptionInput ? descriptionInput.value.trim() : '';

                // If no custom description is provided, use the selected file type as the description
                if (!description) {
                    description = selectedFileType;
                }

                formData.append('file_types', selectedFileType);
                formData.append('descriptions', description);
            });

            const uploadBtn = document.getElementById('inlineUploadBtn');
            const originalBtnText = uploadBtn.innerHTML;
            uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Uploading...';
            uploadBtn.disabled = true;

            const porId = document.getElementById('porId').dataset.porId; // Get POR ID from data attribute

            fetch(`/attach-files/${porId}`, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Files uploaded successfully!');
                    clearAllInlineFiles();
                    // Reload the page to show updated attached files list
                    location.reload(); 
                } else {
                    alert('Error uploading files: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred during upload.');
            })
            .finally(() => {
                uploadBtn.innerHTML = originalBtnText;
                uploadBtn.disabled = false;
            });
        });
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const stageSelect = document.getElementById('stageSelect');
            if (stageSelect) {
                const mainContent = document.querySelector('main');
                const applyFiledStyle = () => {
                    if (stageSelect.value === 'filed') {
                        mainContent.classList.add('filed-stage');
                        const cards = mainContent.querySelectorAll('.por-card');
                        cards.forEach(card => {
                            card.classList.add('filed-stage-inner');
                        });
                    } else {
                        mainContent.classList.remove('filed-stage');
                        const cards = mainContent.querySelectorAll('.por-card');
                        cards.forEach(card => {
                            card.classList.remove('filed-stage-inner');
                        });
                    }
                };

                // Apply on page load
                applyFiledStyle();

                // Apply on change
                stageSelect.addEventListener('change', applyFiledStyle);
            }
        });
    </script>
</body>
</html>