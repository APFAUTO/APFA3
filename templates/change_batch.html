<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ company_info.name }} POR Automator - Advanced Batch Manager</title>
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <style>
        [x-cloak] { display: none !important; }
        .glass-effect {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .gradient-text {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .pulse-glow {
            animation: pulse-glow 2s ease-in-out infinite alternate;
        }
        @keyframes pulse-glow {
            from { box-shadow: 0 0 20px rgba(59, 130, 246, 0.5); }
            to { box-shadow: 0 0 30px rgba(59, 130, 246, 0.8); }
        }
        .dark-mode .glass-effect {
            background: rgba(30, 41, 59, 0.8);
            border: 1px solid rgba(148, 163, 184, 0.3);
        }
        .company-blue {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8, #1e40af);
        }
        .company-green {
            background: linear-gradient(135deg, #10b981, #059669, #047857);
        }
        .slide-in {
            animation: slideIn 0.5s ease-out;
        }
        @keyframes slideIn {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .bounce-in {
            animation: bounceIn 0.6s ease-out;
        }
        @keyframes bounceIn {
            0% { transform: scale(0.3); opacity: 0; }
            50% { transform: scale(1.05); }
            70% { transform: scale(0.9); }
            100% { transform: scale(1); opacity: 1; }
        }
    </style>
</head>
<body class="min-h-screen font-inter bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-100"
      x-data="batchManager()"
      x-init="init()"
      :class="company === 'fdec' ? 'dark-mode' : ''">

    <!-- Theme-aware background -->
    <div class="fixed inset-0 bg-gradient-to-br transition-all duration-1000"
         :class="company === 'fdec' ? 'from-slate-900 via-slate-800 to-gray-900' : 'from-slate-50 via-blue-50 to-indigo-100'">
    </div>

    <div class="relative z-10 flex min-h-screen">
        {% include '_sidebar.html' %}

        <!-- Main Content -->
        <main class="flex-1 p-8 ml-20">
            <!-- Header -->
            <div class="mb-8 slide-in">
                <div class="flex items-center justify-between mb-6">
                    <div>
                        <h1 class="text-4xl font-bold mb-2"
                           :class="company === 'fdec' ? 'text-gray-100' : 'text-blue-900'"
                           x-text="`ðŸš€ Advanced Batch Manager - ${company.toUpperCase()}`">
                        </h1>
                        <p class="text-lg opacity-75"
                           :class="company === 'fdec' ? 'text-gray-300' : 'text-gray-600'">
                            Intelligent batch processing with real-time analytics and dual-company support
                        </p>
                    </div>
                    <div class="flex items-center space-x-4">
                        <div class="px-4 py-2 rounded-full glass-effect"
                             :class="company === 'fdec' ? 'text-gray-200' : 'text-blue-600'">
                            <i class="fas fa-database mr-2"></i>
                            <span x-text="company.toUpperCase() + ' Database'"></span>
                        </div>
                        <div class="px-4 py-2 rounded-full glass-effect"
                             :class="company === 'fdec' ? 'text-gray-200' : 'text-blue-600'">
                            <i class="fas fa-clock mr-2"></i>
                            <span x-text="formatTime(currentTime)"></span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main Dashboard -->
            <div class="grid grid-cols-1 xl:grid-cols-3 gap-8 mb-8">
                <!-- Current Status Card -->
                <div class="xl:col-span-1">
                    <div class="bg-white/90 backdrop-blur-xl rounded-2xl p-6 shadow-xl border border-gray-200/50 glass-effect bounce-in"
                         :class="company === 'fdec' ? 'bg-slate-800/90' : 'bg-white/90'">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-xl font-semibold"
                               :class="company === 'fdec' ? 'text-gray-100' : 'text-gray-900'">
                                ðŸ“Š Current Status
                            </h3>
                            <div class="w-3 h-3 rounded-full pulse-glow"
                                 :class="company === 'fdec' ? 'bg-gray-400' : 'bg-blue-500'"></div>
                        </div>

                        <div class="space-y-4">
                            <div class="flex justify-between items-center">
                                <span :class="company === 'fdec' ? 'text-gray-300' : 'text-gray-600'">Current Batch #</span>
                                <span class="text-2xl font-bold"
                                      :class="company === 'fdec' ? 'text-gray-100' : 'text-blue-600'"
                                      x-text="currentBatchNumber">
                                </span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span :class="company === 'fdec' ? 'text-gray-300' : 'text-gray-600'">Next Available</span>
                                <span class="text-xl font-semibold"
                                      :class="company === 'fdec' ? 'text-gray-100' : 'text-blue-500'"
                                      x-text="nextBatchNumber">
                                </span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span :class="company === 'fdec' ? 'text-gray-300' : 'text-gray-600'">Health Status</span>
                                <span class="px-3 py-1 rounded-full text-sm font-medium"
                                      :class="healthStatus === 'HEALTHY' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'"
                                      x-text="healthStatus">
                                </span>
                            </div>
                                                    </div>

                    </div>
                </div>
<!-- Batch Configuration Card -->
                <div class="xl:col-span-2">
                    <div class="bg-white/90 backdrop-blur-xl rounded-2xl p-6 shadow-xl border border-gray-200/50 glass-effect bounce-in"
                         :class="company === 'fdec' ? 'bg-slate-800/90' : 'bg-white/90'"
                         style="animation-delay: 0.1s;">

                        <div class="flex items-center justify-between mb-6">
                            <h3 class="text-xl font-semibold"
                               :class="company === 'fdec' ? 'text-gray-100' : 'text-gray-900'">
                                 Batch Configuration
                            </h3>
                            <div class="flex items-center space-x-2">
                                <span class="px-3 py-1 rounded-full text-xs font-medium"
                                      :class="company === 'fdec' ? 'bg-gray-700 text-gray-200' : 'bg-blue-100 text-blue-800'"
                                      x-text="company.toUpperCase()">
                                </span>
                            </div>
                        </div>

                        <form @submit.prevent="startBatch()" class="space-y-6">
                            <!-- Batch Range Input -->
                            <div>
                                <label class="block text-sm font-medium mb-3"
                                       :class="company === 'fdec' ? 'text-gray-300' : 'text-gray-700'">
                                     Batch Number Range
                                </label>
                                <div class="flex space-x-3">
                                    <input type="text"
                                           x-model="batchStart"
                                           @focus="isEditing = true"
                                           @blur="isEditing = false"
                                           placeholder="Start (e.g., 100)"
                                           class="flex-1 px-4 py-3 border-2 rounded-xl text-lg focus:ring-2 focus:ring-opacity-50 transition-all duration-200"
                                           :class="company === 'fdec'
                                                  ? 'border-gray-600 focus:border-gray-400 focus:ring-gray-500 bg-slate-700 text-gray-100'
                                                  : 'border-blue-300 focus:border-blue-500 focus:ring-blue-200'"
                                           required>
                                    <div class="flex items-center">
                                        <span class="text-2xl font-bold"
                                              :class="company === 'fdec' ? 'text-gray-300' : 'text-blue-600'">
                                            -
                                        </span>
                                    </div>
                                    <input type="text"
                                           x-model="batchEnd"
                                           @focus="isEditing = true"
                                           @blur="isEditing = false"
                                           placeholder="End (e.g., 200)"
                                           class="flex-1 px-4 py-3 border-2 rounded-xl text-lg focus:ring-2 focus:ring-opacity-50 transition-all duration-200"
                                           :class="company === 'fdec'
                                                  ? 'border-gray-600 focus:border-gray-400 focus:ring-gray-500 bg-slate-700 text-gray-100'
                                                  : 'border-blue-300 focus:border-blue-500 focus:ring-blue-200'"
                                           required>
                                </div>
                                <p class="mt-2 text-sm"
                                   :class="company === 'fdec' ? 'text-gray-400' : 'text-gray-500'">
                                    Format: start-end (e.g., 100-200, 5000-5100)
                                </p>
                            </div>

                            
                            <!-- Batch Preview -->
                            <div class="p-4 rounded-lg border-2"
                                 :class="company === 'fdec'
                                        ? 'border-gray-600 bg-gray-800/50'
                                        : 'border-blue-300 bg-blue-50/50'">
                                <h4 class="font-semibold mb-2"
                                   :class="company === 'fdec' ? 'text-gray-200' : 'text-blue-800'">
                                     Batch Preview
                                </h4>
                                <div class="grid grid-cols-2 gap-4 text-sm">
                                    <div>
                                        <span :class="company === 'fdec' ? 'text-gray-300' : 'text-blue-600'">Range Size:</span>
                                        <span class="font-medium ml-2" x-text="batchEnd - batchStart + 1"></span>
                                    </div>
                                    <div>
                                        <span :class="company === 'fdec' ? 'text-gray-300' : 'text-blue-600'">Current Usage:</span>
                                        <span class="font-medium ml-2" x-text="Math.max(0, currentBatchNumber - batchStart + 1)"></span>
                                    </div>
                                    <div>
                                        <span :class="company === 'fdec' ? 'text-gray-300' : 'text-blue-600'">Remaining:</span>
                                        <span class="font-medium ml-2" x-text="Math.max(0, batchEnd - currentBatchNumber + 1)"></span>
                                    </div>
                                    <div>
                                        <span :class="company === 'fdec' ? 'text-gray-300' : 'text-blue-600'">Progress:</span>
                                        <span class="font-medium ml-2" x-text="Math.round(((currentBatchNumber - batchStart + 1) / (batchEnd - batchStart + 1)) * 100) + '%'"></span>
                                    </div>
                                </div>
                            </div>

                            <!-- Action Buttons -->
                            <div class="flex space-x-4">
                                <button type="submit"
                                        :disabled="isLoading"
                                        class="flex-1 px-6 py-4 rounded-xl font-semibold shadow-lg transition-all duration-300 hover:scale-105 flex items-center justify-center space-x-2"
                                        :class="isLoading
                                               ? 'opacity-50 cursor-not-allowed'
                                               : company === 'fdec'
                                                 ? 'bg-gray-700 hover:bg-gray-600 text-white'
                                                 : 'bg-blue-600 hover:bg-blue-700 text-white'">
                                    <i class="fas fa-rocket" :class="isLoading ? 'fa-spin' : ''"></i>
                                    <span x-text="isLoading ? 'Starting...' : ' Start Batch'"></span>
                                </button>
                                <button type="button"
                                        @click="resetBatch()"
                                        class="px-6 py-4 rounded-xl font-semibold shadow-lg transition-all duration-300 hover:scale-105 flex items-center space-x-2"
                                        :class="company === 'fdec'
                                               ? 'bg-gray-600 hover:bg-gray-500 text-gray-200'
                                               : 'bg-blue-100 hover:bg-blue-200 text-blue-800'">
                                    <i class="fas fa-undo"></i>
                                    <span>Reset</span>
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Progress Tracking -->
            <div x-show="showProgress" x-transition:enter="slide-in" x-transition:enter-start="opacity-0 transform translate-y-4" x-transition:enter-end="opacity-100 transform translate-y-0">
                <div class="bg-white/90 backdrop-blur-xl rounded-2xl p-6 shadow-xl border border-gray-200/50 glass-effect"
                     :class="company === 'fdec' ? 'bg-slate-800/90' : 'bg-white/90'">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-semibold"
                           :class="company === 'fdec' ? 'text-gray-100' : 'text-gray-900'">
                             Live Batch Progress
                        </h3>
                        <div class="flex items-center space-x-2">
                            <div class="w-2 h-2 rounded-full animate-pulse"
                                 :class="company === 'fdec' ? 'bg-gray-400' : 'bg-blue-500'"></div>
                            <span class="text-sm"
                                  :class="company === 'fdec' ? 'text-gray-300' : 'text-gray-600'">
                                Real-time Updates
                            </span>
                        </div>
                    </div>

                    <!-- Progress Bar -->
                    <div class="mb-6">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-sm font-medium"
                                  :class="company === 'fdec' ? 'text-gray-300' : 'text-gray-700'">
                                Overall Progress
                            </span>
                            <span class="text-sm font-bold"
                                  :class="company === 'fdec' ? 'text-gray-100' : 'text-blue-600'"
                                  x-text="progressPercentage + '%'">
                            </span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-3 overflow-hidden">
                            <div class="h-full rounded-full transition-all duration-500 ease-out"
                                 :class="company === 'fdec'
                                        ? 'bg-gradient-to-r from-gray-600 to-gray-500'
                                        : 'bg-gradient-to-r from-blue-500 to-indigo-500'"
                                 :style="`width: ${progressPercentage}%`">
                            </div>
                        </div>
                    </div>

                    <!-- Progress Stats -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="text-center p-3 rounded-lg"
                             :class="company === 'fdec' ? 'bg-gray-800/50' : 'bg-blue-50'">
                            <div class="text-2xl font-bold"
                                 :class="company === 'fdec' ? 'text-gray-100' : 'text-blue-600'"
                                 x-text="currentBatchNumber">
                            </div>
                            <div class="text-xs"
                                 :class="company === 'fdec' ? 'text-gray-300' : 'text-blue-700'">
                                Current Batch
                            </div>
                        </div>
                        <div class="text-center p-3 rounded-lg"
                             :class="company === 'fdec' ? 'bg-gray-800/50' : 'bg-blue-50'">
                            <div class="text-2xl font-bold"
                                 :class="company === 'fdec' ? 'text-gray-100' : 'text-blue-600'"
                                 x-text="batchEnd - currentBatchNumber">
                            </div>
                            <div class="text-xs"
                                 :class="company === 'fdec' ? 'text-gray-300' : 'text-blue-700'">
                                Remaining
                            </div>
                        </div>
                        <div class="text-center p-3 rounded-lg"
                             :class="company === 'fdec' ? 'bg-gray-800/50' : 'bg-blue-50'">
                            <div class="text-2xl font-bold"
                                 :class="company === 'fdec' ? 'text-gray-100' : 'text-blue-600'"
                                 x-text="batchEnd - batchStart + 1">
                            </div>
                            <div class="text-xs"
                                 :class="company === 'fdec' ? 'text-gray-300' : 'text-blue-700'">
                                Total Range
                            </div>
                        </div>
                    </div>

                    <!-- Batch Complete Message -->
                    <div x-show="batchComplete" x-transition:enter="bounce-in" class="mt-6 p-4 rounded-lg border-2"
                         :class="company === 'fdec'
                                ? 'border-gray-600 bg-gray-800/50'
                                : 'border-blue-300 bg-blue-50/50'">
                        <div class="text-center">
                            <div class="text-4xl mb-2"></div>
                            <h4 class="text-lg font-semibold mb-2"
                               :class="company === 'fdec' ? 'text-gray-100' : 'text-blue-800'">
                                Batch Complete!
                            </h4>
                            <p class="mb-4"
                              :class="company === 'fdec' ? 'text-gray-300' : 'text-blue-700'">
                                All batch numbers have been used. Ready for a new batch range!
                            </p>
                            <button @click="resetBatch()"
                                    class="px-6 py-3 rounded-lg font-semibold transition-all duration-200 hover:scale-105"
                                    :class="company === 'fdec'
                                           ? 'bg-gray-700 hover:bg-gray-600 text-white'
                                           : 'bg-blue-600 hover:bg-blue-700 text-white'">
                                 Set New Batch Range
                            </button>
                        </div>
                    </div>
                </div>
            </div>

                    </main>
    </div>

    <!-- Toast Notifications -->
    <div x-show="showToast" x-transition:enter="slide-in" x-transition:enter-start="opacity-0 transform translate-x-full" x-transition:enter-end="opacity-100 transform translate-x-0"
         class="fixed top-4 right-4 z-50">
        <div class="px-6 py-4 rounded-lg shadow-lg flex items-center space-x-3"
             :class="toastType === 'success'
                    ? (company === 'fdec' ? 'bg-emerald-600' : 'bg-green-600')
                    : (company === 'fdec' ? 'bg-red-600' : 'bg-red-600')"
             style="animation-delay: 0.5s;">
            <i :class="toastType === 'success' ? 'fas fa-check-circle' : 'fas fa-exclamation-triangle'"></i>
            <span class="text-white font-medium" x-text="toastMessage"></span>
            <button @click="showToast = false" class="text-white hover:text-gray-200">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>

    <script>
        function batchManager() {
            return {
                // Data
                company: '{{ company | safe }}',
                currentBatchNumber: 0,
                nextBatchNumber: 0,
                totalPORs: 0,
                healthStatus: 'HEALTHY',
                batchStart: '',
                batchEnd: '',
                showProgress: false,
                showAnalytics: false,
                batchComplete: false,
                progressPercentage: 0,
                isLoading: false,
                isEditing: false,
                currentTime: new Date(),


                // Toast
                showToast: false,
                toastMessage: '',
                toastType: 'success',

                // Initialize
                init() {
                    this.loadCurrentStatus();
                    this.startRealTimeUpdates();
                    this.startTimeUpdates();
                },

                // Load current batch status
                async loadCurrentStatus() {
                    try {
                        const response = await fetch('/check-batch-status');
                        const data = await response.json();

                        if (data.current_po) {
                            this.currentBatchNumber = data.current_po;
                            this.nextBatchNumber = data.current_po + 1;
                            if (!this.isEditing) {
                                this.batchStart = data.batch_start || '';
                                this.batchEnd = data.batch_end || '';
                            }
                            this.showProgress = true;
                            this.updateProgress(); // Re-calculate progress with the new data
                        }

                        // Load analytics if available
                        this.showAnalytics = true;

                    } catch (error) {
                        console.error('Error loading batch status:', error);
                        this.showToast('Error loading batch status', 'error');
                    }
                },

                // Centralized state update function
                updateBatchState(data) {
                    this.currentBatchNumber = data.current_po;
                    this.nextBatchNumber = data.current_po + 1;
                    this.batchStart = data.batch_start || data.current_po;
                    this.batchEnd = data.batch_end;
                    this.showProgress = true;
                    this.updateProgress();
                },

                // Start batch processing (Overhauled)
                async startBatch() {
                    const self = this;
                    this.isLoading = true;

                    if (!this.batchStart || !this.batchEnd) {
                        this.showToast('Please enter both start and end batch numbers', 'error');
                        this.isLoading = false;
                        return;
                    }

                    const start = parseInt(this.batchStart);
                    const end = parseInt(this.batchEnd);

                    if (isNaN(start) || isNaN(end) || start >= end) {
                        this.showToast('End batch must be a number greater than start', 'error');
                        this.isLoading = false;
                        return;
                    }

                    this.stopRealTimeUpdates();
                    try {
                        const batchRange = `${start}-${end}`;
                        const payload = {
                            batch_range: batchRange,
                            company: this.company
                        };
                        console.log('[DEBUG] Sending to /change-batch:', JSON.stringify(payload, null, 2));

                        const response = await fetch('/change-batch', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        console.log('[DEBUG] Received response object:', response);
                        const data = await response.json();
                        console.log('[DEBUG] Parsed response data:', data);

                        if (data.success) {
                            this.updateBatchState(data);
                            this.showToast('Batch started successfully!', 'success');
                        } else {
                            this.showToast(data.error || 'Failed to start batch', 'error');
                        }
                    } catch (error) {
                        console.error('Error starting batch:', error);
                        self.showToast('An unexpected error occurred.', 'error');
                    } finally {
                        this.isLoading = false;
                        this.startRealTimeUpdates();
                    }
                },


                // Reset batch form
                resetBatch() {
                    this.batchStart = '';
                    this.batchEnd = '';
                    this.batchComplete = false;
                    this.showProgress = false;
                    this.showToast('Batch form reset', 'success');
                },

                // Update progress calculations
                updateProgress() {
                    const start = parseInt(this.batchStart);
                    const end = parseInt(this.batchEnd);

                    if (!isNaN(start) && !isNaN(end) && start < end) {
                        const current = this.currentBatchNumber;
                        const total = end - start + 1;
                        
                        if (total > 0) {
                            const used = Math.max(0, current - start);
                            this.progressPercentage = Math.min(100, Math.round((used / total) * 100));
                        } else {
                            this.progressPercentage = 0;
                        }

                        this.batchComplete = current >= end;
                    } else {
                        this.progressPercentage = 0;
                        this.batchComplete = false;
                    }
                },

                // Real-time updates
                pollingTimer: null,
                startRealTimeUpdates() {
                    if (this.pollingTimer) clearInterval(this.pollingTimer);
                    this.pollingTimer = setInterval(() => {
                        this.loadCurrentStatus();
                        this.updateProgress();
                    }, 5000); // Update every 5 seconds
                },
                stopRealTimeUpdates() {
                    if (this.pollingTimer) {
                        clearInterval(this.pollingTimer);
                        this.pollingTimer = null;
                    }
                },

                // Time updates
                startTimeUpdates() {
                    setInterval(() => {
                        this.currentTime = new Date();
                    }, 1000);
                },

                // Utility functions
                formatTime(date) {
                    return date.toLocaleTimeString();
                },

                showToast(message, type = 'success') {
                    this.toastMessage = message;
                    this.toastType = type;
                    this.showToast = true;

                    setTimeout(() => {
                        this.showToast = false;
                    }, 5000);
                },

            }
        }
    </script>
</body>
</html>
