
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ company_info.name }} POR Automator - PPE Reporting</title>
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'inter': ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'primary': {
                            50: '#eff6ff',
                            100: '#dbeafe',
                            500: '#3b82f6',
                            600: '#2563eb',
                            700: '#1d4ed8',
                            800: '#1e40af',
                            900: '#1e3a8a',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        /* Dark Mode Styles */
        .dark-mode {
            background: linear-gradient(135deg, #1a1a2e, #16213e, #0f3460) !important;
            color: #e2e8f0 !important;
        }
        
        .dark-mode .bg-white\/80 {
            background-color: rgba(30, 41, 59, 0.8) !important;
        }
        
        .dark-mode .text-gray-900 {
            color: #f1f5f9 !important;
        }
        
        .dark-mode .text-gray-600 {
            color: #cbd5e1 !important;
        }
        
        .dark-mode .text-gray-700 {
            color: #e2e8f0 !important;
        }
        
        .dark-mode .bg-gray-50 {
            background-color: #1e293b !important;
        }
        
        .dark-mode .border-gray-200\/50 {
            border-color: rgba(51, 65, 85, 0.5) !important;
        }
        
        .dark-mode .bg-gray-100 {
            background-color: #334155 !important;
        }
        
        .dark-mode .hover\:bg-gray-100:hover {
            background-color: #475569 !important;
        }
        
        /* Enhanced dark mode for all UI elements */
        .dark-mode .bg-white {
            background-color: #1e293b !important;
        }
        
        .dark-mode .bg-gray-50\/50 {
            background-color: rgba(30, 41, 59, 0.5) !important;
        }
        
        .dark-mode .border-gray-200 {
            border-color: #475569 !important;
        }
        
        .dark-mode .bg-blue-50 {
            background-color: #1e3a8a !important;
        }
        
        .dark-mode .text-blue-900 {
            color: #60a5fa !important;
        }
        
        .dark-mode .text-blue-700 {
            color: #93c5fd !important;
        }
        
        .dark-mode .bg-green-50 {
            background-color: #065f46 !important;
        }
        
        .dark-mode .text-green-600 {
            color: #34d399 !important;
        }
        
        .dark-mode .bg-orange-50 {
            background-color: #92400e !important;
        }
        
        .dark-mode .text-orange-600 {
            color: #fbbf24 !important;
        }
        
        .dark-mode .bg-purple-50 {
            background-color: #581c87 !important;
        }
        
        .dark-mode .text-purple-600 {
            color: #a78bfa !important;
        }
        
        /* Dark mode for form elements */
        .dark-mode input[type="text"],
        .dark-mode input[type="email"],
        .dark-mode input[type="password"],
        .dark-mode select,
        .dark-mode textarea {
            background-color: #334155 !important;
            border-color: #475569 !important;
            color: #f1f5f9 !important;
        }
        
        .dark-mode input[type="text"]:focus,
        .dark-mode input[type="email"]:focus,
        .dark-mode input[type="password"]:focus,
        .dark-mode select:focus,
        .dark-mode textarea:focus {
            border-color: #60a5fa !important;
            box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.1) !important;
        }
        
        /* Dark mode for tables */
        .dark-mode table {
            background-color: #1e293b !important;
        }
        
        .dark-mode th {
            background-color: #334155 !important;
            color: #f1f5f9 !important;
        }
        
        .dark-mode td {
            background-color: #1e293b !important;
            color: #e2e8f0 !important;
        }
        
        .dark-mode tr:hover td {
            background-color: #334155 !important;
        }
        
        /* Dark mode for modals */
        .dark-mode .modal {
            background-color: #1e293b !important;
        }
        
        .dark-mode .modal-content {
            background-color: #334155 !important;
            border-color: #475569 !important;
        }
        
        /* Dark mode for Quick Actions */
        .dark-mode .bg-blue-50 {
            background-color: #1e3a8a !important;
        }
        
        .dark-mode .bg-indigo-50 {
            background-color: #312e81 !important;
        }
        
        .dark-mode .bg-green-50 {
            background-color: #065f46 !important;
        }
        
        .dark-mode .bg-emerald-50 {
            background-color: #064e3b !important;
        }
        
        .dark-mode .bg-purple-50 {
            background-color: #581c87 !important;
        }
        
        .dark-mode .bg-pink-50 {
            background-color: #831843 !important;
        }
        
        .dark-mode .border-blue-200 {
            border-color: #312e81 !important;
        }
        
        .dark-mode .border-green-200 {
            border-color: #064e3b !important;
        }
        
        .dark-mode .border-purple-200 {
            border-color: #581c87 !importan;
        }
        
        .dark-mode .hover\:from-blue-100:hover {
            background-color: #1e40af !important;
        }
        
        .dark-mode .hover\:to-indigo-100:hover {
            background-color: #3730a3 !important;
        }
        
        .dark-mode .hover\:from-green-100:hover {
            background-color: #047857 !important;
        }
        
        .dark-mode .hover\:to-emerald-100:hover {
            background-color: #065f46 !important;
        }
        
        .dark-mode .hover\:from-purple-100:hover {
            background-color: #6d28d9 !important;
        }
        
        .dark-mode .hover\:to-pink-100:hover {
            background-color: #9f1239 !important;
        }
        
        /* Dark mode for gradient backgrounds in Quick Actions */
        .dark-mode .bg-gradient-to-r.from-blue-50.to-indigo-50 {
            background: linear-gradient(to right, #1e3a8a, #312e81) !important;
        }
        
        .dark-mode .bg-gradient-to-r.from-green-50.to-emerald-50 {
            background: linear-gradient(to right, #065f46, #064e3b) !important;
        }
        
        .dark-mode .bg-gradient-to-r.from-purple-50.to-pink-50 {
            background: linear-gradient(to right, #581c87, #831843) !important;
        }
        
        .dark-mode .hover\:from-blue-100.hover\:to-indigo-100:hover {
            background: linear-gradient(to right, #1e40af, #3730a3) !important;
        }
        
        .dark-mode .hover\:from-green-100.hover\:to-emerald-100:hover {
            background: linear-gradient(to right, #047857, #065f46) !important;
        }
        
        .dark-mode .hover\:from-purple-100.hover\:to-pink-100:hover {
            background: linear-gradient(to right, #6d28d9, #9f1239) !important;
        }
    </style>
</head>
<body class="min-h-screen font-inter">
    
    <!-- Background layer -->
    <div class="{% if company == 'fdec' %}dark-mode fdec-rain-background{% else %}bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-100{% endif %} fixed inset-0 z-0"></div>
    
    <!-- Animated Background Pattern -->
    <div class="fixed inset-0 overflow-hidden pointer-events-none">
        <div class="absolute -top-40 -right-40 w-80 h-80 bg-gradient-to-br from-blue-400/20 to-indigo-500/20 rounded-full blur-3xl animate-pulse"></div>
        <div class="absolute -bottom-40 -left-40 w-80 h-80 bg-gradient-to-tr from-blue-300/20 to-cyan-400/20 rounded-full blur-3xl animate-pulse delay-1000"></div>
    </div>

    <div class="relative z-10 flex min-h-screen">
        {% include '_sidebar.html' %}

        <!-- Main Content -->
        <main class="flex-1 p-8 ml-20">
            <!-- Header -->
            <div class="flex items-center justify-between mb-8">
                <div>
                    <h1 class="text-4xl font-bold text-gray-900 mb-2">PPE Reporting</h1>
                    <p class="text-gray-600 text-lg">Generate reports on PPE data</p>
                </div>
                
                <!-- Quick Actions -->
                <div class="flex space-x-3">
                    <a href="{{ url_for('routes.ppe_logger') }}" class="px-6 py-3 bg-white text-gray-700 font-semibold rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 hover:scale-105 border border-gray-200">
                        <i class="fas fa-arrow-left mr-2"></i>
                        Back to PPE Logger
                    </a>
                </div>
            </div>

            <!-- Reporting Dashboard -->
            <div class="flex space-x-4">
                <!-- Main Chart -->
                <div class="w-3/4">
                    <div class="bg-white/80 backdrop-blur-xl rounded-2xl p-6 shadow-xl border border-gray-200/50">
                        <div class="flex justify-between items-center mb-4">
                            <div>
                                <h2 class="text-2xl font-bold text-gray-900">PPE Usage</h2>
                            </div>
                            <div class="flex space-x-2">
                                <select id="chart-type" class="bg-gray-100 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                                    <option value="line">Line</option>
                                    <option value="bar">Bar</option>
                                    <option value="pie">Pie</option>
                                </select>
                                <button id="export-pdf" class="px-4 py-2 bg-red-500 text-white font-semibold rounded-lg shadow-md hover:bg-red-600 transition-colors duration-300">
                                    <i class="fas fa-file-pdf mr-2"></i>PDF
                                </button>
                                <button id="export-csv" class="px-4 py-2 bg-green-500 text-white font-semibold rounded-lg shadow-md hover:bg-green-600 transition-colors duration-300">
                                    <i class="fas fa-file-csv mr-2"></i>CSV
                                </button>
                            </div>
                        </div>
                        <canvas id="ppe-chart"></canvas>
                    </div>
                </div>

                <!-- Right Sidebar -->
                <div class="w-1/4">
                    <div class="bg-white/80 backdrop-blur-xl rounded-2xl p-6 shadow-xl border border-gray-200/50">
                        <h3 class="text-xl font-bold text-gray-900 mb-4">Filters</h3>

                        <!-- Department Filter -->
                        <div class="mb-4">
                            <label for="department-filter" class="block mb-2 text-sm font-medium text-gray-900">Department</label>
                            <select id="department-filter" multiple class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5"></select>
                            <div class="flex items-center mt-2">
                                <input id="compare-departments" type="checkbox" class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500">
                                <label for="compare-departments" class="ml-2 text-sm font-medium text-gray-900">Compare Departments</label>
                            </div>
                        </div>

                        <!-- PPE Item Filter -->
                        <div class="mb-4">
                            <label for="ppe-item-filter" class="block mb-2 text-sm font-medium text-gray-900">PPE Item</label>
                            <select id="ppe-item-filter" multiple class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5"></select>
                        </div>

                        <!-- Employee Filter -->
                        <div class="mb-4">
                            <label for="employee-filter" class="block mb-2 text-sm font-medium text-gray-900">Employee</label>
                            <input type="text" id="employee-filter" list="employee-list" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" placeholder="Search by name or ID">
                            <datalist id="employee-list"></datalist>
                            <div class="flex items-center mt-2">
                                <input id="compare-to-department" type="checkbox" class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500">
                                <label for="compare-to-department" class="ml-2 text-sm font-medium text-gray-900">Compare with Department Average</label>
                            </div>
                        </div>

                        <!-- Date Range Filter -->
                        <div class="mb-4">
                            <label class="block mb-2 text-sm font-medium text-gray-900">Date Range</label>
                            <div class="flex space-x-2">
                                <input type="date" id="start-date-filter" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                                <input type="date" id="end-date-filter" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                            </div>
                        </div>

                        <button id="reset-filters" class="w-full px-4 py-2 bg-gray-500 text-white font-semibold rounded-lg shadow-md hover:bg-gray-600 transition-colors duration-300">Reset Filters</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const ctx = document.getElementById('ppe-chart').getContext('2d');
            let ppeChart;

            // Function to fetch data and update the chart
            function updateChart() {
                // Collect filter values
                const department = Array.from(document.getElementById('department-filter').selectedOptions).map(option => option.value);
                const ppeItem = Array.from(document.getElementById('ppe-item-filter').selectedOptions).map(option => option.value);
                const employeeId = document.getElementById('employee-filter').value;
                const startDate = document.getElementById('start-date-filter').value;
                const endDate = document.getElementById('end-date-filter').value;
                const chartType = document.getElementById('chart-type').value;
                const compareDepartments = document.getElementById('compare-departments').checked;
                const compareToDepartment = document.getElementById('compare-to-department').checked;

                // Build the API URL
                let url = '/api/ppe/usage?';
                let departmentUrl = '/api/ppe/usage?';

                if (department.length > 0) {
                    const departmentParams = `department=${department.join(',')}&`;
                    url += departmentParams;
                    departmentUrl += departmentParams;
                }
                if (ppeItem.length > 0) {
                    const ppeItemParams = `ppe_item=${ppeItem.join(',')}&`;
                    url += ppeItemParams;
                    departmentUrl += ppeItemParams;
                }
                if (startDate) {
                    const startDateParams = `start_date=${startDate}&`;
                    url += startDateParams;
                    departmentUrl += startDateParams;
                }
                if (endDate) {
                    const endDateParams = `end_date=${endDate}&`;
                    url += endDateParams;
                    departmentUrl += endDateParams;
                }

                if (employeeId) {
                    url += `employee_id=${employeeId}&`;
                }

                // Fetch data from the API
                Promise.all([fetch(url).then(res => res.json()), compareToDepartment && employeeId ? fetch(departmentUrl).then(res => res.json()) : Promise.resolve(null)])
                    .then(([data, departmentData]) => {
                        if (ppeChart) {
                            ppeChart.destroy();
                        }

                        // Process data for the chart
                        const labels = [...new Set(data.map(item => item.date))].sort();
                        const datasets = [];

                        if (chartType === 'pie') {
                            const pieData = {};
                            data.forEach(item => {
                                const key = compareDepartments ? item.department : 'All Departments';
                                if (!pieData[key]) {
                                    pieData[key] = 0;
                                }
                                pieData[key] += item.quantity;
                            });

                            datasets.push({
                                data: Object.values(pieData),
                                backgroundColor: [
                                    'rgba(255, 99, 132, 0.7)',
                                    'rgba(54, 162, 235, 0.7)',
                                    'rgba(255, 206, 86, 0.7)',
                                    'rgba(75, 192, 192, 0.7)',
                                    'rgba(153, 102, 255, 0.7)',
                                    'rgba(255, 159, 64, 0.7)'
                                ],
                            });

                            ppeChart = new Chart(ctx, {
                                type: 'pie',
                                data: {
                                    labels: Object.keys(pieData),
                                    datasets: datasets
                                }
                            });

                        } else { // Line and Bar charts
                            if (compareToDepartment && employeeId && departmentData) {
                                const employeeData = {};
                                data.forEach(item => {
                                    if (!employeeData[item.date]) {
                                        employeeData[item.date] = 0;
                                    }
                                    employeeData[item.date] += item.quantity;
                                });

                                const departmentAverage = {};
                                const departmentUsage = {};
                                departmentData.forEach(item => {
                                    if (!departmentUsage[item.date]) {
                                        departmentUsage[item.date] = { total: 0, count: 0 };
                                    }
                                    departmentUsage[item.date].total += item.quantity;
                                    departmentUsage[item.date].count++;
                                });

                                for (const date in departmentUsage) {
                                    departmentAverage[date] = departmentUsage[date].total / departmentUsage[date].count;
                                }

                                const employeeValues = labels.map(label => employeeData[label] || 0);
                                const departmentAverageValues = labels.map(label => departmentAverage[label] || 0);

                                datasets.push({
                                    label: `Employee ${employeeId}`,
                                    data: employeeValues,
                                    borderColor: 'rgba(255, 99, 132, 1)',
                                    backgroundColor: 'rgba(255, 99, 132, 0.7)',
                                    fill: false
                                });

                                datasets.push({
                                    label: 'Department Average',
                                    data: departmentAverageValues,
                                    borderColor: 'rgba(54, 162, 235, 1)',
                                    backgroundColor: 'rgba(54, 162, 235, 0.7)',
                                    fill: false
                                });

                            } else if (compareDepartments) {
                                const dataByDepartment = {};
                                data.forEach(item => {
                                    if (!dataByDepartment[item.department]) {
                                        dataByDepartment[item.department] = {};
                                    }
                                    if (!dataByDepartment[item.department][item.date]) {
                                        dataByDepartment[item.department][item.date] = 0;
                                    }
                                    dataByDepartment[item.department][item.date] += item.quantity;
                                });

                                const colors = [
                                    'rgba(255, 99, 132, 1)',
                                    'rgba(54, 162, 235, 1)',
                                    'rgba(255, 206, 86, 1)',
                                    'rgba(75, 192, 192, 1)',
                                    'rgba(153, 102, 255, 1)',
                                    'rgba(255, 159, 64, 1)'
                                ];

                                let colorIndex = 0;
                                for (const dept in dataByDepartment) {
                                    const departmentData = labels.map(label => dataByDepartment[dept][label] || 0);
                                    datasets.push({
                                        label: dept,
                                        data: departmentData,
                                        borderColor: colors[colorIndex % colors.length],
                                        backgroundColor: colors[colorIndex % colors.length].replace('1)', '0.7)'),
                                        fill: false
                                    });
                                    colorIndex++;
                                }
                            } else {
                                const aggregatedData = {};
                                data.forEach(item => {
                                    if (!aggregatedData[item.date]) {
                                        aggregatedData[item.date] = 0;
                                    }
                                    aggregatedData[item.date] += item.quantity;
                                });

                                const aggregatedValues = labels.map(label => aggregatedData[label] || 0);
                                datasets.push({
                                    label: 'All Selected Departments',
                                    data: aggregatedValues,
                                    borderColor: 'rgba(75, 192, 192, 1)',
                                    backgroundColor: 'rgba(75, 192, 192, 0.7)',
                                    fill: false
                                });
                            }

                            ppeChart = new Chart(ctx, {
                                type: chartType,
                                data: {
                                    labels: labels,
                                    datasets: datasets
                                },
                                options: {
                                    responsive: true,
                                    scales: {
                                        x: {
                                            display: true,
                                            title: {
                                                display: true,
                                                text: 'Date'
                                            }
                                        },
                                        y: {
                                            display: true,
                                            title: {
                                                display: true,
                                                text: 'Quantity'
                                            }
                                        }
                                    }
                                }
                            });
                        }
                    });
            }

            // Function to populate filter dropdowns
            function populateFilters() {
                fetch('/api/ppe/filters')
                    .then(response => response.json())
                    .then(data => {
                        const departmentFilter = document.getElementById('department-filter');
                        data.departments.forEach(dept => {
                            const option = document.createElement('option');
                            option.value = dept;
                            option.textContent = dept;
                            departmentFilter.appendChild(option);
                        });

                        const ppeItemFilter = document.getElementById('ppe-item-filter');
                        data.ppe_items.forEach(item => {
                            const option = document.createElement('option');
                            option.value = item;
                            option.textContent = item;
                            ppeItemFilter.appendChild(option);
                        });

                        const employeeList = document.getElementById('employee-list');
                        data.employees.forEach(employee => {
                            const option = document.createElement('option');
                            option.value = employee.employee_id;
                            option.textContent = `${employee.employee_name} (${employee.employee_id})`;
                            employeeList.appendChild(option);
                        });
                    });
            }

            // Event listeners for filters
            document.getElementById('department-filter').addEventListener('change', updateChart);
            document.getElementById('ppe-item-filter').addEventListener('change', updateChart);
            document.getElementById('employee-filter').addEventListener('input', updateChart);
            document.getElementById('start-date-filter').addEventListener('change', updateChart);
            document.getElementById('end-date-filter').addEventListener('change', updateChart);
            document.getElementById('chart-type').addEventListener('change', updateChart);
            document.getElementById('compare-departments').addEventListener('change', updateChart);
            document.getElementById('compare-to-department').addEventListener('change', updateChart);

            document.getElementById('reset-filters').addEventListener('click', () => {
                document.getElementById('department-filter').selectedIndex = -1;
                document.getElementById('ppe-item-filter').selectedIndex = -1;
                document.getElementById('employee-filter').value = '';
                document.getElementById('start-date-filter').value = '';
                document.getElementById('end-date-filter').value = '';
                updateChart();
            });

            document.getElementById('export-csv').addEventListener('click', () => {
                const department = Array.from(document.getElementById('department-filter').selectedOptions).map(option => option.value);
                const ppeItem = Array.from(document.getElementById('ppe-item-filter').selectedOptions).map(option => option.value);
                const employeeId = document.getElementById('employee-filter').value;
                const startDate = document.getElementById('start-date-filter').value;
                const endDate = document.getElementById('end-date-filter').value;

                let url = '/api/ppe/export/csv?';
                if (department.length > 0) url += `department=${department.join(',')}&`;
                if (ppeItem.length > 0) url += `ppe_item=${ppeItem.join(',')}&`;
                if (employeeId) url += `employee_id=${employeeId}&`;
                if (startDate) url += `start_date=${startDate}&`;
                if (endDate) url += `end_date=${endDate}&`;

                window.location.href = url;
            });

            document.getElementById('export-pdf').addEventListener('click', () => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                html2canvas(document.querySelector("#ppe-chart")).then(canvas => {
                    const imgData = canvas.toDataURL('image/png');
                    doc.addImage(imgData, 'PNG', 10, 10, 180, 100);
                    doc.save('ppe_report.pdf');
                });
            });

            // Initial chart load and filter population
            populateFilters();
            updateChart();
        });
    </script>
</body>
</html>
