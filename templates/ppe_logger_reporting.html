<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ company_info.name }} POR Automator - PPE Reporting</title>
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'inter': ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'primary': {
                            50: '#eff6ff',
                            100: '#dbeafe',
                            500: '#3b82f6',
                            600: '#2563eb',
                            700: '#1d4ed8',
                            800: '#1e40af',
                            900: '#1e3a8a',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        /* Dark Mode Styles */
        .dark-mode {
            background: linear-gradient(135deg, #1a1a2e, #16213e, #0f3460) !important;
            color: #e2e8f0 !important;
        }
        
        .dark-mode .bg-white\/80 {
            background-color: rgba(30, 41, 59, 0.8) !important;
        }
        
        .dark-mode .text-gray-900 {
            color: #f1f5f9 !important;
        }
        
        .dark-mode .text-gray-600 {
            color: #cbd5e1 !important;
        }
        
        .dark-mode .text-gray-700 {
            color: #e2e8f0 !important;
        }
        
        .dark-mode .bg-gray-50 {
            background-color: #1e293b !important;
        }
        
        .dark-mode .border-gray-200\/50 {
            border-color: rgba(51, 65, 85, 0.5) !important;
        }
        
        .dark-mode .bg-gray-100 {
            background-color: #334155 !important;
        }
        
        .dark-mode .hover\:bg-gray-100:hover {
            background-color: #475569 !important;
        }
        
        /* Enhanced dark mode for all UI elements */
        .dark-mode .bg-white {
            background-color: #1e293b !important;
        }
        
        .dark-mode .bg-gray-50\/50 {
            background-color: rgba(30, 41, 59, 0.5) !important;
        }
        
        .dark-mode .border-gray-200 {
            border-color: #475569 !important;
        }
        
        .dark-mode .bg-blue-50 {
            background-color: #1e3a8a !important;
        }
        
        .dark-mode .text-blue-900 {
            color: #60a5fa !important;
        }
        
        .dark-mode .text-blue-700 {
            color: #93c5fd !important;
        }
        
        .dark-mode .bg-green-50 {
            background-color: #065f46 !important;
        }
        
        .dark-mode .text-green-600 {
            color: #34d399 !important;
        }
        
        .dark-mode .bg-orange-50 {
            background-color: #92400e !important;
        }
        
        .dark-mode .text-orange-600 {
            color: #fbbf24 !important;
        }
        
        .dark-mode .bg-purple-50 {
            background-color: #581c87 !important;
        }
        
        .dark-mode .text-purple-600 {
            color: #a78bfa !important;
        }
        
        /* Dark mode for form elements */
        .dark-mode input[type="text"],
        .dark-mode input[type="email"],
        .dark-mode input[type="password"],
        .dark-mode select,
        .dark-mode textarea {
            background-color: #334155 !important;
            border-color: #475569 !important;
            color: #f1f5f9 !important;
        }
        
        .dark-mode input[type="text"]:focus,
        .dark-mode input[type="email"]:focus,
        .dark-mode input[type="password"]:focus,
        .dark-mode select:focus,
        .dark-mode textarea:focus {
            border-color: #60a5fa !important;
            box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.1) !important;
        }
        
        /* Dark mode for tables */
        .dark-mode table {
            background-color: #1e293b !important;
        }
        
        .dark-mode th {
            background-color: #334155 !important;
            color: #f1f5f9 !important;
        }
        
        .dark-mode td {
            background-color: #1e293b !important;
            color: #e2e8f0 !important;
        }
        
        .dark-mode tr:hover td {
            background-color: #334155 !important;
        }
        
        /* Dark mode for modals */
        .dark-mode .modal {
            background-color: #1e293b !important;
        }
        
        .dark-mode .modal-content {
            background-color: #334155 !important;
            border-color: #475569 !important;
        }
        
        /* Dark mode for Quick Actions */
        .dark-mode .bg-blue-50 {
            background-color: #1e3a8a !important;
        }
        
        .dark-mode .bg-indigo-50 {
            background-color: #312e81 !important;
        }
        
        .dark-mode .bg-green-50 {
            background-color: #065f46 !important;
        }
        
        .dark-mode .bg-emerald-50 {
            background-color: #064e3b !important;
        }
        
        .dark-mode .bg-purple-50 {
            background-color: #581c87 !important;
        }
        
        .dark-mode .bg-pink-50 {
            background-color: #831843 !important;
        }
        
        .dark-mode .border-blue-200 {
            border-color: #312e81 !important;
        }
        
        .dark-mode .border-green-200 {
            border-color: #064e3b !important;
        }
        
        .dark-mode .border-purple-200 {
            border-color: #581c87 !important;
        }
        
        .dark-mode .hover\:from-blue-100:hover {
            background-color: #1e40af !important;
        }
        
        .dark-mode .hover\:to-indigo-100:hover {
            background-color: #3730a3 !important;
        }
        
        .dark-mode .hover\:from-green-100:hover {
            background-color: #047857 !important;
        }
        
        .dark-mode .hover\:to-emerald-100:hover {
            background-color: #065f46 !important;
        }
        
        .dark-mode .hover\:from-purple-100:hover {
            background-color: #6d28d9 !important;
        }
        
        .dark-mode .hover\:to-pink-100:hover {
            background-color: #9f1239 !important;
        }
        
        /* Dark mode for gradient backgrounds in Quick Actions */
        .dark-mode .bg-gradient-to-r.from-blue-50.to-indigo-50 {
            background: linear-gradient(to right, #1e3a8a, #312e81) !important;
        }
        
        .dark-mode .bg-gradient-to-r.from-green-50.to-emerald-50 {
            background: linear-gradient(to right, #065f46, #064e3b) !important;
        }
        
        .dark-mode .bg-gradient-to-r.from-purple-50.to-pink-50 {
            background: linear-gradient(to right, #581c87, #831843) !important;
        }
        
        .dark-mode .hover\:from-blue-100.hover\:to-indigo-100:hover {
            background: linear-gradient(to right, #1e40af, #3730a3) !important;
        }
        
        .dark-mode .hover\:from-green-100.hover\:to-emerald-100:hover {
            background: linear-gradient(to right, #047857, #065f46) !important;
        }
        
        .dark-mode .hover\:from-purple-100.hover\:to-pink-100:hover {
            background: linear-gradient(to right, #6d28d9, #9f1239) !important;
        }

        /* Specific backgrounds for filter bar */
        .fdec-filter-background {
            background: linear-gradient(135deg, #1a1a2e, #16213e, #0f3460) !important;
            color: #e2e8f0 !important;
        }

        .ap-filter-background {
            background: linear-gradient(135deg, #0f3460, #16213e, #1a1a2e) !important; /* A blue gradient for A&P */
            color: #e2e8f0 !important;
        }
    </style>
</head>
<body class="min-h-screen font-inter {% if company == 'fdec' %}dark-mode{% endif %}">
    
    <!-- Background layer -->
    <div class="{% if company == 'fdec' %}fdec-rain-background{% else %}bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-100{% endif %} fixed inset-0 z-0"></div>
    
    <!-- Animated Background Pattern -->
    <div class="fixed inset-0 overflow-hidden pointer-events-none">
        <div class="absolute -top-40 -right-40 w-80 h-80 bg-gradient-to-br from-blue-400/20 to-indigo-500/20 rounded-full blur-3xl animate-pulse"></div>
        <div class="absolute -bottom-40 -left-40 w-80 h-80 bg-gradient-to-tr from-blue-300/20 to-cyan-400/20 rounded-full blur-3xl animate-pulse delay-1000"></div>
    </div>

    <div class="relative z-10 flex min-h-screen">
        {% include '_sidebar.html' %}

        <!-- Main Content -->
        <main class="flex-1 p-8 ml-20">
            <!-- Header -->
            <div class="flex items-center justify-between mb-8">
                <div>
                    <h1 class="text-4xl font-bold text-gray-900 mb-2 {% if company == 'fdec' %}text-white{% endif %}">PPE Reporting</h1>
                    <p class="text-gray-600 text-lg {% if company == 'fdec' %}text-gray-300{% endif %}">Generate reports on PPE data</p>
                </div>
                
                <!-- Quick Actions -->
                <div class="flex space-x-3">
                    <a href="{{ url_for('routes.ppe_logger') }}" class="px-6 py-3 bg-white text-gray-700 font-semibold rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 hover:scale-105 border border-gray-200">
                        <i class="fas fa-arrow-left mr-2"></i>
                        Back to PPE Logger
                    </a>
                </div>
            </div>

            <!-- Reporting Dashboard -->
            <div class="grid grid-cols-12 gap-6">
                <!-- Main Chart and Data -->
                <div class="col-span-9">
                    <div class="bg-white/80 backdrop-blur-xl rounded-2xl p-6 shadow-xl border border-gray-200/50">
                        <div class="flex justify-between items-center mb-4">
                            <div class="flex space-x-4">
                                <select id="chart-type" class="bg-gray-100 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5">
                                    <option value="bar">Bar Chart</option>
                                    <option value="line">Line Chart</option>
                                    <option value="pie">Pie Chart</option>
                                </select>
                                <select id="report-by" class="bg-gray-100 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5">
                                    <option value="unit">By Unit</option>
                                    <option value="item">By Item</option>
                                </select>
                                <select id="timeframe-select" class="bg-gray-100 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5">
                                    <option value="all">All Time</option>
                                    <option value="day">Today</option>
                                    <option value="week">This Week</option>
                                    <option value="month">This Month</option>
                                    <option value="3month">Last 3 Months</option>
                                    <option value="6month">Last 6 Months</option>
                                    <option value="year">This Year</option>
                                </select>
                            </div>
                            <div class="flex space-x-2">
                                <button id="export-pdf" class="px-4 py-2 bg-red-500 text-white font-semibold rounded-lg shadow-md hover:bg-red-600 transition-colors duration-300">
                                    <i class="fas fa-file-pdf mr-2"></i>PDF
                                </button>
                                <button id="export-csv" class="px-4 py-2 bg-green-500 text-white font-semibold rounded-lg shadow-md hover:bg-green-600 transition-colors duration-300">
                                    <i class="fas fa-file-csv mr-2"></i>CSV
                                </button>
                            </div>
                        </div>
                        <div id="no-filters-message" class="hidden text-center text-gray-500">
                            <p>NO FILTERS SELECTED</p>
                        </div>
                        <canvas id="ppe-chart" class="mb-6"></canvas>
                    </div>
                </div>
                <!-- Filters -->
                <div class="col-span-3">
                    <div class="rounded-2xl p-6 shadow-xl border border-gray-200/50 space-y-6
                                {% if company == 'fdec' %}bg-gray-800/80 text-white{% else %}bg-white/80 text-gray-900{% endif %} backdrop-blur-xl">
                        <h3 class="text-xl font-bold {% if company == 'fdec' %}text-white{% else %}text-gray-900{% endif %}">Filters</h3>

                        <div class="flex items-center justify-center py-4">
                            <span class="mr-3 text-sm font-medium {% if company == 'fdec' %}text-white{% else %}text-gray-900{% endif %}">Employee</span>
                            <label for="filter-toggle" class="inline-flex relative items-center cursor-pointer">
                                <input type="checkbox" value="" id="filter-toggle" class="sr-only peer" checked>
                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-blue-600"></div>
                            </label>
                            <span class="ml-3 text-sm font-medium {% if company == 'fdec' %}text-white{% else %}text-gray-900{% endif %}">Department</span>
                        </div>

                        <!-- Department Filter -->
                        <div id="department-filter-container">
                            <label for="department-search" class="block mb-2 text-sm font-medium {% if company == 'fdec' %}text-white{% else %}text-gray-900{% endif %}">Department</label>
                            <input type="text" id="department-search" class="{% if company == 'fdec' %}bg-gray-700 border-gray-600 text-white{% else %}bg-gray-50 border-gray-300 text-gray-900{% endif %} text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" placeholder="Search departments...">
                            <div class="mt-2 max-h-40 overflow-y-auto border rounded-lg {% if company == 'fdec' %}border-gray-600{% else %}border-gray-200{% endif %}">
                                <div class="p-2 border-b {% if company == 'fdec' %}border-gray-600 sticky top-0 bg-gray-700{% else %}border-gray-200 sticky top-0 bg-gray-50{% endif %}">
                                    <input type="checkbox" id="department-check-all" class="w-4 h-4 text-blue-600 {% if company == 'fdec' %}bg-gray-600 border-gray-500{% else %}bg-gray-100 border-gray-300{% endif %} rounded focus:ring-blue-500">
                                    <label for="department-check-all" class="ml-2 text-sm font-medium {% if company == 'fdec' %}text-white{% else %}text-gray-900{% endif %}">Select All</label>
                                </div>
                                <div id="department-list" class="p-2 space-y-1"></div>
                            </div>
                        </div>

                        <!-- Employee Filter -->
                        <div id="employee-filter-container">
                            <label for="employee-search" class="block mb-2 text-sm font-medium {% if company == 'fdec' %}text-white{% else %}text-gray-900{% endif %}">Employee</label>
                            <input type="text" id="employee-search" class="{% if company == 'fdec' %}bg-gray-700 border-gray-600 text-white{% else %}bg-gray-50 border-gray-300 text-gray-900{% endif %} text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" placeholder="Search employees...">
                            <div class="mt-2 max-h-40 overflow-y-auto border rounded-lg {% if company == 'fdec' %}border-gray-600{% else %}border-gray-200{% endif %}">
                                <div class="p-2 border-b {% if company == 'fdec' %}border-gray-600 sticky top-0 bg-gray-700{% else %}border-gray-200 sticky top-0 bg-gray-50{% endif %}">
                                    <input type="checkbox" id="employee-check-all" class="w-4 h-4 text-blue-600 {% if company == 'fdec' %}bg-gray-600 border-gray-500{% else %}bg-gray-100 border-gray-300{% endif %} rounded focus:ring-blue-500">
                                    <label for="employee-check-all" class="ml-2 text-sm font-medium {% if company == 'fdec' %}text-white{% else %}text-gray-900{% endif %}">Select All</label>
                                </div>
                                <div id="employee-list" class="p-2 space-y-1"></div>
                            </div>
                        </div>
                        
                        <!-- Custom Date Range -->
                        <div>
                            <button id="custom-range-toggle" class="text-sm font-medium {% if company == 'fdec' %}text-blue-400{% else %}text-blue-600{% endif %} hover:underline">Custom Range</button>
                            <div id="custom-range-filters" class="hidden mt-2 space-y-2">
                                <input type="date" id="start-date-filter" class="{% if company == 'fdec' %}bg-gray-700 border-gray-600 text-white{% else %}bg-gray-50 border-gray-300 text-gray-900{% endif %} text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                                <input type="date" id="end-date-filter" class="{% if company == 'fdec' %}bg-gray-700 border-gray-600 text-white{% else %}bg-gray-50 border-gray-300 text-gray-900{% endif %} text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                            </div>
                        </div>

                        <button id="reset-filters" class="w-full px-4 py-2 bg-gray-500 text-white font-semibold rounded-lg shadow-md hover:bg-gray-600 transition-colors duration-300">Reset Filters</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const ctx = document.getElementById('ppe-chart').getContext('2d');
            let ppeChart;
            let allEmployees = [];
            let allDepartments = [];

            // Filter elements
            const departmentSearch = document.getElementById('department-search');
            const departmentList = document.getElementById('department-list');
            const departmentCheckAll = document.getElementById('department-check-all');
            const employeeSearch = document.getElementById('employee-search');
            const employeeList = document.getElementById('employee-list');
            const employeeCheckAll = document.getElementById('employee-check-all');
            const timeframeSelect = document.getElementById('timeframe-select');
            const customRangeToggle = document.getElementById('custom-range-toggle');
            const customRangeFilters = document.getElementById('custom-range-filters');
            const startDateFilter = document.getElementById('start-date-filter');
            const endDateFilter = document.getElementById('end-date-filter');
            const chartTypeSelect = document.getElementById('chart-type');
            const reportBySelect = document.getElementById('report-by');
            const resetFiltersBtn = document.getElementById('reset-filters');
            const noFiltersMessage = document.getElementById('no-filters-message');
            const ppeChartCanvas = document.getElementById('ppe-chart');
            const filterToggle = document.getElementById('filter-toggle');
            const departmentFilterContainer = document.getElementById('department-filter-container');
            const employeeFilterContainer = document.getElementById('employee-filter-container');

            filterToggle.addEventListener('change', () => {
                if (filterToggle.checked) { // Department
                    departmentFilterContainer.classList.remove('opacity-50');
                    departmentSearch.disabled = false;
                    employeeFilterContainer.classList.add('opacity-50');
                    employeeSearch.disabled = true;
                } else { // Employee
                    departmentFilterContainer.classList.add('opacity-50');
                    departmentSearch.disabled = true;
                    employeeFilterContainer.classList.remove('opacity-50');
                    employeeSearch.disabled = false;
                }
                updateChart();
            });

            // Trigger the change event on load to set the initial state
            filterToggle.dispatchEvent(new Event('change'));

            function renderChecklist(container, items, searchInput, checkAll, type) {
                container.innerHTML = '';
                items.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'flex items-center item-container';
                    div.innerHTML = `
                        <input type="checkbox" id="item-${item.id}" value="${item.id}" class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 item-checkbox" data-type="${type}">
                        <label for="item-${item.id}" class="ml-2 text-sm font-medium {% if company == 'fdec' %}text-white{% else %}text-gray-900{% endif %}">${item.name}</label>
                    `;
                    container.appendChild(div);
                });

                searchInput.addEventListener('input', () => {
                    const searchTerm = searchInput.value.toLowerCase();
                    container.querySelectorAll('.item-container').forEach(itemDiv => {
                        const label = itemDiv.querySelector('label');
                        if (label.textContent.toLowerCase().includes(searchTerm)) {
                            itemDiv.style.display = 'flex';
                        } else {
                            itemDiv.style.display = 'none';
                        }
                    });
                });

                checkAll.addEventListener('change', () => {
                    container.querySelectorAll('.item-checkbox').forEach(checkbox => {
                        checkbox.checked = checkAll.checked;
                    });
                    updateChart();
                });
            }

            function getSelected(type) {
                const container = type === 'department' ? departmentList : employeeList;
                return Array.from(container.querySelectorAll('.item-checkbox:checked')).map(cb => cb.value);
            }

            function updateChart() {
                const selectedDepartments = getSelected('department');
                const selectedEmployees = getSelected('employee');
                const startDate = startDateFilter.value;
                const endDate = endDateFilter.value;
                const chartType = chartTypeSelect.value;
                const reportBy = reportBySelect.value;
                const displayBy = filterToggle.checked ? 'department' : 'employee';

                if ((displayBy === 'department' && selectedDepartments.length === 0) || (displayBy === 'employee' && selectedEmployees.length === 0)) {
                    noFiltersMessage.classList.remove('hidden');
                    ppeChartCanvas.classList.add('hidden');
                    if (ppeChart) {
                        ppeChart.destroy();
                    }
                    return; // Stop further execution
                } else {
                    noFiltersMessage.classList.add('hidden');
                    ppeChartCanvas.classList.remove('hidden');
                }

                let url = '/api/ppe/usage?';
                if (displayBy === 'department' && selectedDepartments.length > 0) {
                    url += `department=${selectedDepartments.join(',')}&`;
                } else if (displayBy === 'employee' && selectedEmployees.length > 0) {
                    url += `employee_id=${selectedEmployees.join(',')}&`;
                }
                if (startDate) url += `start_date=${startDate}&`;
                if (endDate) url += `end_date=${endDate}&`;

                fetch(url)
                    .then(response => response.json())
                    .then(data => {
                        if (ppeChart) {
                            ppeChart.destroy();
                        }

                        let labels, datasets, options;

                        if (chartType === 'pie') {
                            const dataByItem = data.reduce((acc, item) => {
                                const key = reportBy === 'unit' ? (displayBy === 'department' ? item.department : `${item.known_as} ${item.surname}`) : item.ppe_item;
                                acc[key] = (acc[key] || 0) + item.quantity;
                                return acc;
                            }, {});
                            labels = Object.keys(dataByItem);
                            datasets = [{
                                label: 'Items Issued',
                                data: Object.values(dataByItem),
                                backgroundColor: labels.map((_, i) => `hsl(${i * 360 / labels.length}, 70%, 50%)`)
                            }];
                            options = {
                                responsive: true,
                                plugins: {
                                    legend: {
                                        position: 'top',
                                    },
                                    tooltip: {
                                        callbacks: {
                                            label: function(tooltipItem) {
                                                const total = tooltipItem.chart.getDatasetMeta(0).total;
                                                const value = tooltipItem.raw;
                                                const percentage = ((value / total) * 100).toFixed(2) + '%';
                                                return `${tooltipItem.label}: ${value} (${percentage})`;
                                            }
                                        }
                                    }
                                }
                            };
                        } else { // Bar and Line charts
                            if (reportBy === 'unit') {
                                if (displayBy === 'department') {
                                    const dataByDepartment = data.reduce((acc, item) => {
                                        if (!acc[item.department]) {
                                            acc[item.department] = {};
                                        }
                                        acc[item.department][item.date] = (acc[item.department][item.date] || 0) + item.quantity;
                                        return acc;
                                    }, {});

                                    labels = [...new Set(data.map(item => item.date))].sort();
                                    datasets = Object.keys(dataByDepartment).map((department, index) => {
                                        const color = `hsl(${(index * 60) % 360}, 70%, 50%)`;
                                        return {
                                            label: department,
                                            data: labels.map(date => dataByDepartment[department][date] || 0),
                                            backgroundColor: color,
                                            borderColor: color,
                                            borderWidth: 1
                                        };
                                    });
                                } else { // employee
                                    const dataByEmployee = data.reduce((acc, item) => {
                                        const employeeName = `${item.known_as} ${item.surname}`;
                                        if (!acc[employeeName]) {
                                            acc[employeeName] = {};
                                        }
                                        acc[employeeName][item.date] = (acc[employeeName][item.date] || 0) + item.quantity;
                                        return acc;
                                    }, {});

                                    labels = [...new Set(data.map(item => item.date))].sort();
                                    datasets = Object.keys(dataByEmployee).map((employeeName, index) => {
                                        const color = `hsl(${(index * 60) % 360}, 70%, 50%)`;
                                        return {
                                            label: employeeName,
                                            data: labels.map(date => dataByEmployee[employeeName][date] || 0),
                                            backgroundColor: color,
                                            borderColor: color,
                                            borderWidth: 1
                                        };
                                    });
                                }
                            } else { // By Item
                                const dataByItem = data.reduce((acc, item) => {
                                    acc[item.ppe_item] = (acc[item.ppe_item] || 0) + item.quantity;
                                    return acc;
                                }, {});
                                labels = Object.keys(dataByItem);
                                datasets = [{
                                    label: 'Items Issued',
                                    data: Object.values(dataByItem),
                                    backgroundColor: labels.map((_, i) => `hsl(${i * 360 / labels.length}, 70%, 50%)`)
                                }];
                            }
                            options = {
                                responsive: true,
                                scales: {
                                    x: { display: true, title: { display: true, text: 'Date' } },
                                    y: { display: true, title: { display: true, text: 'Quantity' } }
                                }
                            };
                        }

                        ppeChart = new Chart(ctx, {
                            type: chartType,
                            data: { labels, datasets },
                            options: options
                        });
                    });
            }
            
            function populateFilters() {
                fetch('/api/ppe/filters')
                    .then(response => response.json())
                    .then(data => {
                        allDepartments = data.departments.map(d => ({ id: d, name: d, type: 'department' }));
                        allEmployees = data.employees.map(e => ({ id: e.employee_id, name: e.employee_name, type: 'employee' }));
                        
                        renderChecklist(departmentList, allDepartments, departmentSearch, departmentCheckAll, 'department');
                        renderChecklist(employeeList, allEmployees, employeeSearch, employeeCheckAll, 'employee');
                        
                        departmentList.addEventListener('change', updateChart);
                        employeeList.addEventListener('change', updateChart);
                    });
            }

            function setTimeframe(period) {
                const end = new Date();
                let start = new Date();
                switch (period) {
                    case 'day': start.setDate(end.getDate() - 1); break;
                    case 'week': start.setDate(end.getDate() - 7); break;
                    case 'month': start.setMonth(end.getMonth() - 1); break;
                    case '3month': start.setMonth(end.getMonth() - 3); break;
                    case '6month': start.setMonth(end.getMonth() - 6); break;
                    case 'year': start.setFullYear(end.getFullYear() - 1); break;
                    case 'all': start = null; break;
                }
                startDateFilter.value = start ? start.toISOString().split('T')[0] : '';
                endDateFilter.value = end.toISOString().split('T')[0];
                if (period === 'all') endDateFilter.value = '';
            }

            // Event Listeners
            chartTypeSelect.addEventListener('change', updateChart);
            reportBySelect.addEventListener('change', updateChart);
            timeframeSelect.addEventListener('change', (e) => {
                setTimeframe(e.target.value);
                updateChart();
            });
            customRangeToggle.addEventListener('click', () => customRangeFilters.classList.toggle('hidden'));
            startDateFilter.addEventListener('change', updateChart);
            endDateFilter.addEventListener('change', updateChart);
            resetFiltersBtn.addEventListener('click', () => {
                departmentSearch.value = '';
                employeeSearch.value = '';
                
                departmentList.querySelectorAll('.item-checkbox').forEach(checkbox => checkbox.checked = false);
                employeeList.querySelectorAll('.item-checkbox').forEach(checkbox => checkbox.checked = false);

                departmentCheckAll.checked = false;
                employeeCheckAll.checked = false;
                timeframeSelect.value = 'all';
                setTimeframe('all');
                updateChart();
            });

            document.getElementById('export-csv').addEventListener('click', () => {
                const selectedDepartments = getSelected('department');
                const selectedEmployees = getSelected('employee');
                const startDate = startDateFilter.value;
                const endDate = endDateFilter.value;
                const displayBy = filterToggle.checked ? 'department' : 'employee';

                let url = '/api/ppe/export/csv?';
                if (displayBy === 'department' && selectedDepartments.length > 0) {
                    url += `department=${selectedDepartments.join(',')}&`;
                } else if (displayBy === 'employee' && selectedEmployees.length > 0) {
                    url += `employee_id=${selectedEmployees.join(',')}&`;
                }
                if (startDate) url += `start_date=${startDate}&`;
                if (endDate) url += `end_date=${endDate}&`;

                window.location.href = url;
            });

            document.getElementById('export-pdf').addEventListener('click', () => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                const chartCanvas = document.getElementById('ppe-chart');

                doc.text("PPE Usage Report", 14, 15);
                doc.text(`Generated on: ${new Date().toLocaleDateString()}`, 14, 22);

                html2canvas(chartCanvas).then(canvas => {
                    const imgData = canvas.toDataURL('image/png');
                    doc.addImage(imgData, 'PNG', 10, 30, 180, 100);
                    doc.save('ppe_report.pdf');
                });
            });

            // Initial Load
            populateFilters();
            setTimeframe('all');
            updateChart();
        });
    </script>
</body>
</html>
